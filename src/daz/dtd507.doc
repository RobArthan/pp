=IGN
********************************************************************************
dtd507.doc: this file is part of the PPDaz system

Copyright (c) 2002 Lemma 1 Ltd.

See the file LICENSE for your rights to use and change this file.

Contact: Rob Arthan < rda@lemma-one.com >
********************************************************************************
%  %Z% $Revision: 1.142 $ $RCSfile: dtd507.doc,v $ $Date: 2004/06/21 16:32:48 $
=TEX
% TQtemplate.tex
\documentstyle[hol1,11pt,TQ]{article}
\ftlinepenalty=9999
\def\Hide#1{}
\def\Bool{``$\it{:}bool\,$''}
\makeindex
\TPPproject{DAZ PROJECT}  %% Mandatory field
%\TPPvolume{}
%\TPPpart{}
\TPPtitle{Detailed Design: Z Generator}  %% Mandatory field
\TPPref{ISS/HAT/DAZ/DTD507}  %% Mandatory field
\def\SCCSversion{$Revision: 1.142 $%
}
\TPPissue{\SCCSversion}  %% Mandatory field
\TPPdate{\FormatDate{$Date: 2004/06/21 16:32:48 $%
}}
%\TPPstatus{Approved}
\TPPstatus{Draft}
\TPPtype{Specification}
%\TPPkeywords{SPARK}
\TPPauthor{R.D.~Arthan&WIN01}
\TPPauthorisation{D.J.~King & DAZ Team Leader}
\TPPabstract{
This document contains the detailed design for the
Compliance Notation Z Generation.}
%\TPPabstractB{}
%\TPPabstractC{}
%\TPPabstractD{}
%\TPPabstractE{}
%\TPPabstractF{}
\TPPdistribution{\parbox[t]{4.0in}{%
	A.~Smith, DRA \\
	Library}}

%\TPPclass{CLASSIFICATION}
%\def\TPPheadlhs{}
%\def\TPPheadcentre{}
%def\TPPheadrhs{}
%\def\TPPfootlhs{}
%\def\TPPfootcentre{}
%\def\TPPfootrhs{}

\begin{document}
\TPPsetsizes
\makeTPPfrontpage

\vfill
\begin{centering}

\bf Copyright \copyright\ : Lemma 1 Ltd. \number\year

\end{centering}

\newpage
\section{DOCUMENT CONTROL}
\subsection{Contents List}
\tableofcontents
\subsection{Document Cross References}
\bibliographystyle{fmu}
\bibliography{fmu,hatdocs,daz}

\subsection{Changes History}  % to get section number `0.3'
\begin{description}
\item[Issue 1.1-1.21] Initial drafts.
\item[Issue 1.22 (21th September 1994) ] Rework done according to deck-check report reference 0010 and checked by KB.
\item[Issues 1.22-1.34] Phase 3 rework.
\item[Issues 1.35-1.43] Fixed to the Z during type-checking.
\item[Issue 1.44] Final version for issue.
\item[Issue 1.45-1.47] Bug fixes.
\item[Issue 1.48] Enhancements 1, 5, 6, 7 and 20; bug fix 17 (batch 2).
\item[Issue 1.49] Enhancement 10.
\item[Issue 1.50] Issue for review.
\item[Issue 1.51] Exposed $add\_type\_info$.
\item[Issue 1.52 (14th December 1995)] Changes according to desk check report 024.
\item[Issue 1.53] Fixed bug 6 (V0.6).
\item[Issue 1.54] New error message for resolution of issue 1 (V0.6).
\item[Issue 1.55] Updated reference to DRA spec.
\item[Issue 1.56] Added $new\_script1$ for IUCT project WP 1.
\item[Issue 1.57 - 1.58] Changes for IUCT WP 7.
\item[Issue 1.59-1.60] Changes for IUCT WP 2.
\item[Issue 1.61] Further changes for IUCT WP 7.
\item[Issue 1.62-1.65] Additional error messages.
\item[Issue 1.66] IUCT WP 5.
\item[Issue 1.68] IUCT WP 9.
\item[Issue 1.69] Removed $pack\_spec\_with\_modules$ as per new spec.
\item[Issue 1.70] Corrected Z syntax and type errors.
\item[Issue 1.71] First round of syntax/type error correction for IUCT.
\item[Issue 1.72] Typos.
\item[Issue 1.73] Updated Z for HLD504 Appendix Material.
\item[Issue 1.74] Updated references.
\item[Issue 1.75] Tidying.
\item[Issue 1.76] Update for SML97.
\item[Issue 1.77] Enhancement R5 (initial variables in conditionals).
\item{Issue 1.78,1.79} Brought {\it vcs\_body\_fun} and {\it add\_log\_con\_env}
into line with latest specifications.
\item[Issue 1.80] CTLE II R1/3: reverse loops.
\item[Issue 1.81] CTLE II R1/9: SPARK 83 attributes.
\item[Issue 1.82] CTLE II R2/1: global variable unsoundness.
\item[Issue 1.83,1.84] CTLE II R1/11: nested packages.
\item[Issue 1.85] CTLE II R1/1: real types.
\item[Issue 1.86] Fixes to Z spec of {\it update\_envs\_pack\_spec}.
\item[Issue 1.87] Perfomance enhancement for type-checking of specification statements.
\item[Issue 1.88] Fixed {\LaTeX} error.
\item[Issue 1.89] Corrected out-of-date narrative about type-checking.
\item[Issue 1.90] Removed local declarations for Poly/ML port.
\item[Issue 1.91] Index brackets added.
\item[Issues 1.92, 1.93] R0006: spec updates.
\item[Issue 1.94] R0044: checks on array ranges.
\item[Issue 1.95] Support for new SPARK output functions.
\item[Issue 1.96] Applying specification changes from HLD508.
\item[Issue 1.97] Fixing {\LaTeX} and other minor problems for SPC501.
\item[Issue 1.99] R0065: duplicates in context clauses now allowed.
\item[Issue 1.100] Spring 2002 enhancements: syntax changes for interim release.
\item[Issue 1.101] Spring 2002 enhancements: Forward declarations for subprograms.
\item[Issue 1.101--1.107] Spring 2002 enhancements: renaming
\item[Issue 1.108, 1.109] Spring 2002 enhancements: more on named loops.
\item[Issue 1.110] Duplicate renamings and use clauses are now errors.
\item[Issue 1.111] Fixed mismatched type.
\item[Issue 1.112] Full syntax-check-only now implemented.
\item[Issue 1.113] Changed signature of {\it renames\_proc\_common}.
\item[Issue 1.114] More on renaming.
\item[Issue 1.115] Exposed {\it current\_cn\_env} in the signature for diagnostic purposes.
\item[Issue 1.116] New error message for revised treatment of renaming.
\item[Issue 1.117] Error message for misplaced assertions.
\item[Issue 1.118, 1.119] R0051: default parameters (new and modified error messages).
\item[Issue 1.120] Merged in changes for R0062. Error messages for VC browser info get and set.
\item[Issue 1.121] Copyright and banner updates for open source release.
\item[Issue 1.122, 1.123] DAZ-specific updates to banner for open source release
\item[Issue 1.124] Uniform treatment of block statements.
\item[Issue 1.125--1.126] Script deletion.
\item[Issue 1.127] Schemas-as-declarations now catered for in output Z syntax.
\item[Issues 1.128, 1.129] R0067: specification changes for schema references in $\Xi$-lists.
\item[Issues 1.130--1.133] R0066: specification changes for auxiliary variables in $\Xi$-lists.
\item[Issue 1.134] Added exception logging.
\item[Issue 1.135] New error messages for the rationalised error system.
\item[Issues 1.136, 1.137] Updates to the Z specifications after GMP's preliminary review.
\item[Issue 1.138] R0091: the implementation entailed a new internal error message.
\item[Issue 1.139] Improved error messages for type-checking of specification statements.
\item[Issue 1.140] The SPARK program is now referred to as the Ada program.
\item[Issues 1.141-1.142] Reform of the Environments.
\end{description}
\subsection{Changes Forecast}
None.
\section{GENERAL}
\subsection{Scope}
This document contains the detailed design for the functions whose Z specification is given in in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}; it is called for in \cite{ISS/HAT/DAZ/HLD503}.
Sections \ref{BASICDECLARATIONS}-\ref{WEBCLAUSES} contain the design and correspond directly with sections 4-16 of the DRA specification.

\subsection{Introduction}
This document gives the structure (i.e., module) containing the functions defined \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}.
This covers the main semantic processing involved in the extraction of a Z document from a Compliance Notation script.
As usual it also includes a transcription into {\ProductZ} of the relevant parts of the DRA specification.

The overall effect of the processing defined here is to update the {\Product} theory database as if the Z document had been loaded into it and to update internal state representing the environments of  \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0} as implemented in \cite{ISS/HAT/DAZ/DTD513}.
The internal state also includes additional information defined in \cite{ISS/HAT/DAZ/DTD513} and used to record the association of k-slot labels with SPARK program fragments.
This gives all the information required to reduce extraction of the Z document and of the SPARK program to straightforward pretty-printing tasks.



\subsubsection{Purpose and Background}
See \cite{ISS/HAT/DAZ/HLD503}.


\subsubsection{Dependencies}
See \cite{ISS/HAT/DAZ/HLD503}.
%\subsubsection{Possible Enhancements}
\subsubsection{Deficiencies}
None known.


\subsection{Compliance}
For the description of the Z in this document see \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}. Where the Z differs from that in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}, justification has been provided.

In \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0} where names contain double underscores, the implementation has chosen to use only single underscores (no ambiguity results from this).

In {\ProductZ}, subscripts are not decoration. In order to achieve the effect required by \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}, multiple priming has been used and generally, the number of primes in a decoration corresponds to the numeric value of the subscript in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0}.

In a number of places, the Z in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/3.0} (and hence in this document) is recognised to be deficient. In specific cases, agreed with DRA, the implementation has been discussed and agreed, but the Z has not been brought into line with the implementation. Where this is the case, there is a note to draw attention to this fact.







\section{PREAMBLE}
\subsection{Preamble for Z Type-Checking}

The following initialises the theory database when performing a syntax and type check on the Z paragraphs in this document. (This preamble is not processed when building the compliance tool.)

=SMLZ
open_theory"dtd505";
push_pc "z_library";
force_delete_theory"dtd507" handle Fail _ => ();
val _ = set_flag ("z_type_check_only", true);
new_theory "dtd507";
new_parent "dtd513";
=TEX

\subsection{The Signature}
=DOC
signature ÛCNZGeneratorİ = sig
=DESCRIBE
=ENDDOC
As with other signatures, the following would be local declarations
rather than includes if that were allowed.
=SML
include	(* CNTypes CNTypes2 CNBasicDeclsAndExprs *) CNTypes1;
(*	ZParagraphs ZUserInterfaceSupport; *)
=TEX
\section{TYPE-CHECKING}
Type-checking the Z that occurs in specification statements is a somewhat
thorny problem, since some care has to be taken to ensure that
the current theory and the type inference context are appropriate.

At DERA's request, the implementation endeavours to type-check every
Z fragment as soon as it is processed by the Z Generator. Unfortunately,
a simple implementation of this following the structure of the formal
specification of the tool causes each Z fragment to be type-checked
several times. This inefficiency has proved to be very significant
in actual examples.

The checking is most safely done by simulating a call
to the VC generator. To improve performance, the function {\it vcs}
that is the entry point to the VC generator returns a type-checked
specification statement in addition to the VCs. The Z Generator
is then able to store the type-checked specification statement in
its data structures and so avoid repeated type-checking.

In the current implementation, the performance enhancement has
been implemented for specification statements and logical
constant statements as statements but not for other uses of
specification statements. To facilitate future improvements,
the type-checked specification statement is propagated up
the calling tree until it can either be stored for future
reference or until the logic of the formal specification
makes it difficult to pass the value up.

The following SID functions now return a type-checked specification
statement for the caller's benefit:

\begin{tabular}{l}
{\it form\_proc\_pack\_body}\\
{\it form\_proc\_pack\_body\_aux}\\
{\it k\_slot\_stmt}\\
{\it vcs\_aux\_initial}\\
{\it vcs\_body\_proc}\\
{\it vcs\_body\_fun}\\
{\it vcs\_speclabel}
\end{tabular}

The following functions are the ones that are forced to discard a type-checked
specification statement passed up by a supporting function. (I.e., these
are the candidates for future performance enhancements).

\begin{tabular}{l}
{\it form\_proc\_subunit}\\
{\it check\_stub\_spec\_proc}\\
{\it form\_proc}\\
{\it form\_fun\_pack\_body}\\
{\it form\_fun\_subunit}\\
{\it vcs\_body}\\
{\it do\_proper\_body}
\end{tabular}

=TEX
\section{BASIC DECLARATIONS}\label{BASICDECLARATIONS}
\subsection{The SID Function basic\_declaration}
ÿÛBASIC_DECİüüüüüüüüüüüüüüüüüüüüü
Ü	basic_decl : SI_BASIC_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûbasic_decl_pack_specİ : BASIC_DECL -> unit;
=DESCRIBE
ÿÛbasic_decl_pack_specİüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	„Z_DOC;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	¶adjusted_decls : seq BASIC_DECL ·
Ü		pack_env' =
Ü		pack_env «
Ü		{ block_name' í
Ü			Package_consts_types(ÊPackage, consts_types ë adjusted_decls)} ±
Ü		z' = z ë ‹(trans_basic_decl o adjusted_decls)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_decl_otherwiseİ : BASIC_DECL -> unit;
=DESCRIBE
ÿÛbasic_decl_otherwiseİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë ‹(trans_basic_decl o adjust_basic_decl(basic_decl))
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507041	Unsupported language feature encountered in a basic declaration
=ENDDOC
=DOC
val Ûbasic_declarationİ : BASIC_DECL -> unit;
=DESCRIBE
¹Z
Ü	Ûbasic_declarationİ ¦ basic_decl_pack_spec ² basic_decl_otherwise
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function var\_pack\_spec}
=DOC
val Ûvar_pack_specİ : VAR_DECL -> unit;
=DESCRIBE
In the implementation, variable declarations contain lists of identifiers, rather than single identifiers (i.e., they are as in the concrete syntax rather than the Z abstract syntax).
We therefore only deal with a single $VAR\_DECL$ here.
ÿÛvar_pack_specİüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	VAR_DECL;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_vc_vars(ÊPackage, vc_vars À vars) }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function update\_envs\_var}
=DOC
val Ûupdate_subunit_env_varİ : VAR_DECL -> unit;
=DESCRIBE
ÿÛupdate_subunit_env_varİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Subunit_vc_vars(s, s.vc_vars À vars) ²
Ü		dec_lab'  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_dec_env_varİ : VAR_DECL -> unit;
=DESCRIBE
ÿÛupdate_dec_env_varİüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		dec_lab'  d.dec_labels ±
Ü		d' = Declab_vc_vars(d, d.vc_vars À vars) ²
Ü		dec_lab'  d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_spec_env_varİ : VAR_DECL -> unit;
=DESCRIBE
ÿÛupdate_spec_env_varİüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Speclab_w
Ü		(Speclab_vc_vars(s, s.vc_vars À vars),
Ü		s.w À {v : vars· trans_id v.var}) ²
Ü		dec_lab'  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_envs_varİ : VAR_DECL -> unit;
=DESCRIBE
¹Z
Ü		Ûupdate_envs_varİ
Ü	¦	update_subunit_env_var
Ü	±	update_dec_env_var
Ü	±	update_spec_env_var
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function add\_var\_env}
=DOC
val Ûadd_var_envİ : VAR_DECL -> unit;
=DESCRIBE
ÿÛadd_var_envİüüüüüüüüüüüüüü
Ü	„ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' = blocks « {1 í Block_vc_vars(blocks 1, vc_vars' À vars)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID Function add\_var\_init\_env}
=DOC
val Ûadd_var_init_envİ : (VAR_DECL * EXP) -> unit;
=DESCRIBE
ÿÛadd_var_init_envİüüüüüüüüüüüüüü
Ü „ENV;
Ü VAR_DECL;
Ü Block'
÷üüüüüü
Ü ÊBlock' = blocks 1;
Ü init = no_init ±
Ü blocks' = blocks ²
Ü (¶e: EXP· init=init_val e ±
Ü   blocks' = blocks « {1 í 
Ü              Block_var_inits
Ü		(blocks 1, var_inits' À {v: vars·v.var í (e, v.tmark)})})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507043	Attempting to give variable initialisation for ?0 when it is already initialised
=ENDDOC
\subsection{The SID Function adj\_var\_decl}
This SID function is implemented implicitly via direct use
of {\it adjust\_var\_decl}.
ÿÛadj_var_declİüü
Ü „PACK_ENV;
Ü „Z_DOC;
Ü ENV;
Ü Package;
Ü Block';
Ü SI_VAR_DECL; 
Ü VAR_DECL;
Ü od : OPT[SI_BASIC_DECL]
÷
Ü adjust_var_decl(Ê SI_VAR_DECL) = (od,ÊVAR_DECL) ±
Ü ( (od = Nil ± ˜PACK_ENV ± ˜Z_DOC) 
Ü   ²
Ü   ( ¶ BASIC_DEC · od = Value basic_decl ± basic_declaration )
Ü )
ˆüü
\section{DECLARATIONS}\label{DECLARATIONS}
\subsection{The SID function k\_slot\_dec}
ÿÛLABİüüüüüüüüüüüü
Ü	label : LABEL
ˆüüüüüüüüüüüüüü
¹ZAX
Ü	Ûno_labelİ : LABEL
°
¹Z
fun 6 _Ûdotİ_
°
¹ZAX
Ü	_Ûdotİ_: (ID ¸ ID) ­ ID
°
=DOC
val Ûk_slot_decİ : LABEL -> unit;
=DESCRIBE
ÿÛk_slot_decİüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	„ENV;
Ü	LAB;
Ü	ENV;
Ü	Declab;
Ü	Block';
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	dec_env' = dec_env À {label í ÊDeclab};
Ü	subunit_flag'' = True ± block_name = block_name'' dot block_name' ²
Ü	subunit_flag'' = False ± block_name = block_name';
Ü	ÊFlags = ÊFlags';
Ü	ÊIn_Scope = flatten_env(ÊENV);
Ü	blocks' =
Ü	blocks « {1 í Block_dec_labels (blocks 1, dec_labels' À {label})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, $ENV$ should be $„ENV$ and the $blocks'$ component is also updated. (See Implementation.) 
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
507010	?0 is already in use as a declaration label
=ENDDOC
\subsection{The SID function update\_envs\_k\_slot}
=DOC
(* local function Ûupdate_subunit_env_k_slotİ *)
=DESCRIBE
ÿ Ûupdate_subunit_env_k_slotİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	LAB;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Subunit_dec_labels(s, s.dec_labels À {label}) ²
Ü		dec_lab'  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
(* local function Ûupdate_dec_env_k_slotİ *)
=DESCRIBE
ÿ Ûupdate_dec_env_k_slotİüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	LAB;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		dec_lab'  d.dec_labels ±
Ü		d' = Declab_dec_labels(d, d.dec_labels À {label}) ²
Ü		dec_lab'  d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
(* local function Ûupdate_spec_env_k_slotİ *)
=DESCRIBE
ÿ Ûupdate_spec_env_k_slotİüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	LAB;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Speclab_dec_labels(s, s.dec_labels À {label}) ²
Ü		dec_lab'  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûupdate_envs_k_slotİ : LABEL -> unit;
=DESCRIBE
¹Z
Ü		Ûupdate_envs_k_slotİ
Ü	¦	update_subunit_env_k_slot
Ü	±	update_dec_env_k_slot
Ü	±	update_spec_env_k_slot
°
=ENDDOC
\section{STATEMENTS}\label{STATEMENTS}
\subsection{The SID function spec\_stmt}
ÿÛSPEC_STMTİüüüüüüüüüüüü
Ü	specification : Spec
ˆüüüüüüüüüüüüüü
ÿÛspec_stmt_commonİüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	SPEC_STMT;
Ü	LAB;
Ü	ENV;
Ü	Speclab;
Ü	Block';
Ü	named_tills' : ID ­ Z_PRED
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = spec_env À {label í ÊSpeclab};
Ü	ÊSpec = specification;
Ü	formal_body_flag = formal_body_flag';
Ü	till_flag = till_flag';
Ü	(¶n:ID· current_loop_name' = Value n ± till_flag' = True ± named_tills' = {n í till'}) ²
Ü	(till_flag' = False ² current_loop_name' = Nil) ± named_tills' = š;
Ü	till = till'
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûspec_stmt_speclabelİ : {spec :SPEC, label : LABEL} -> unit;
=DESCRIBE
ÿÛspec_stmt_speclabelİüüüüüüüüüüüüüü
Ü	spec_stmt_common;
Ü	Speclab''
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = True;
Ü	ÊSpeclab'' = spec_env spec_lab';
Ü	formal_body_flag = formal_body_flag'';
Ü	fun_flag = fun_flag'';
Ü	fun_header = fun_header'';
Ü	named_tills = named_tills' À named_tills'';
Ü	return = return'';
Ü	vc_vars = vc_vars'';
Ü	vc_pars = vc_pars'' À (flatten_env(ÊENV)).vc_pars;
Ü	vc_log_cons = vc_log_cons'' À vc_log_cons';
Ü	vc_aux_vars = vc_aux_vars'';
Ü	formal_procs = formal_procs'';
Ü	dec_labels = dec_labels''
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507014	specification label ?0 has not been introduced
507015	label ?0 has already been introduced
507033	badly formed logical constant encountered
=ENDDOC
=DOC
val Ûspec_stmt_otherwiseİ : {spec : SPEC, label : LABEL} -> unit;
=DESCRIBE
ÿÛspec_stmt_otherwiseİüüüüüüüüüüüüüü
Ü	spec_stmt_common;
Ü	Formal_Fun'
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = False;
Ü	formal_body_flag = formal_body_flag';
Ü	fun_flag = fun_flag';
Ü	current_formal_fun' = ÊFormal_Fun';
Ü	fun_header = ÊInformal_Fun';
Ü	named_tills = named_tills';
Ü	return =post';
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
¹Z
Ü	Ûspec_stmtİ ¦ spec_stmt_speclabel ² spec_stmt_otherwise
°
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function k\_slot\_stmt}
=DOC
val Ûk_slot_stmtİ : LABEL -> SPEC;
=DESCRIBE
¹Z
Ü	Ûk_slot_stmtİ ¦ spec_stmt
°
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function add\_log\_con\_env}
ÿÛLOGICAL_CONİüüüüüüüüü
Ü	logical_con : ğZ_Decl
ˆüüüüüüüüüüüüüüüü
=DOC
val Ûadd_log_con_envİ : LOG_CON_DEF list -> unit;
=DESCRIBE
ÿÛadd_log_con_envİüüüüüüüüüüü
Ü	„ENV;
Ü	LOGICAL_CON
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, logical_con)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=FAILURE
507032	Declaration of ?0 has already been introduced 
=ENDDOC
\subsection{The SID function remove\_log\_con\_env}
=DOC
val Ûremove_log_con_envİ : unit -> unit;
=DESCRIBE
ÿÛremove_log_con_envİüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, {})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_block}
=TEX
=DOC
	val Ûnew_blockİ : unit -> unit;
=DESCRIBE
ÿÛnew_blockİüüüüüüüü
Ü	„ENV;
Ü	„Block
÷üüüüüüüüüüüüüüü
Ü	ÊBlock = blocks 1;
Ü	ÊBlock' = Block_body_flag (ÊBlock, True);
Ü	blocks' = blocks « §ÊBlock'¢
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function update\_spec\_env\_block}
=TEX
=DOC
	val Ûupdate_spec_env_blockİ : unit -> unit;
=DESCRIBE
ÿÛupdate_spec_env_blockİüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block'; Block'';
Ü	„Speclab'''
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊSpeclab''' = spec_env spec_lab';
Ü	w'''' = w''' À {v : vc_vars' · trans_id v.var};
Ü	Pre'''' = z_many_and({Pre'''} À
Ü	Ş {v : dom var_inits'; ze : Z_EXP; tm : TMARK
Ü	 | ze = trans_exp(first(var_inits' v)) ± tm = second(var_inits' v)·
Ü		{z_eq(zid(trans_id v), slide_to_tmark(ze, tm))} À domain_conds ze});
Ü	ÊIn_Scope'''' = merge_in_scopes (ÊIn_Scope''', ÊIn_Scope');
Ü	ÊSpeclab'''' = Speclab_in_scope(
Ü			Speclab_w(Speclab_pre (ÊSpeclab''', Pre''''), w''''),
Ü			ÊIn_Scope'''');
Ü	spec_env' = spec_env « {spec_lab' í ÊSpeclab''''}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{LOOPS}\label{LOOPS}
\subsection{The SID function new\_scope\_loop}
=DOC
	val Ûnew_scope_loopİ : ID OPT -> unit;
=DESCRIBE
ÿ ÛLOOP_NAMEİ üüüüüüüüüüü
Ü loop_name : OPT[ID]
ˆüüüüüüüüüüüüüü

ÿÛnew_scope_loopİüüüüüüüü
Ü	„ENV;
Ü	Empty_Block;
Ü	LOOP_NAME;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊBlock' = blocks 1;
Ü	pack_spec_flag = stub_flag = subunit_flag =
Ü		declabel_flag = till_flag = body_flag = False;
Ü	formal_body_flag = formal_body_flag';
Ü	fun_flag = fun_flag';
Ü	speclabel_flag = speclabel_flag';
Ü	current_formal_proc = current_formal_proc';
Ü	current_formal_fun = current_formal_fun';
Ü	current_loop_name = loop_name;
Ü	spec_lab = spec_lab'
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\subsection{The SID function end\_scope}

=DOC
val Ûend_scopeİ : unit -> unit;
=DESCRIBE
ÿÛend_scopeİüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = tail blocks
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
=ENDDOC
\subsection{The SID function for\_param}
ÿÛFOR_PARAMİüüüüüüüüüüü
Ü	Param_Spec
÷üüüüüüü
Ü	mode = inn
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûfor_paramİ : ID * TMARK -> unit;
=DESCRIBE
ÿÛfor_paramİüüüüüüüüüüüüü
Ü	„ENV;
Ü	FOR_PARAM
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, {ÊParam_Spec})}
ˆüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=ENDDOC
\subsection{The SID function till\_pred}
ÿÛTILL_PREDİüüüüüüüüüüü
Ü	till : Z_PRED
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûtill_predİ : ZUserInterfaceSupport.Z_TM -> unit;
=DESCRIBE
ÿÛtill_predİüüüüüüüüüüüüü
Ü	„ENV;
Ü	TILL_PRED
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_till(Block_till_flag(blocks 1, True), till)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\section{SUBPROGRAM DECLARATIONS}\label{SUBPROGRAMDECLARATIONS}
The SID function $end\_scope$ used in processing these has already been defined in section \ref{LOOPS}.
\section{PROCEDURES}\label{PROCEDURES}
\subsection{The SID function subunit\_form}
ÿÛIDENTİüüüüüüüüüüüüüüüüüüüüü
Ü	ident : ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûsubunit_formİ : ID -> unit;
=DESCRIBE
ÿÛsubunit_formİüüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_PARENTS;
Ü	SUBUNIT_ENV;
Ü	IDENT;
Ü	„Block;
Ü	Subunit''
÷üüüüüüüüüüüüüüü
Ü	subunit_flag = True;
Ü	ÊBlock = head blocks;
Ü	blocks' = blocks « {1 í ÊBlock'};
Ü	parents = {zmod''.mod_name};
Ü	z' = z ë §z_parents(ÊZ_PARENTS)¢;
Ü	ÊSubunit'' = subunit_env(block_name, ident);
Ü	block_name' = block_name;
Ü	ÊFlags' = ÊFlags;
Ü	ÊIn_Scope' = ÊIn_Scope''
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function subunit\_inf}
=DOC
	val Ûsubunit_infİ : ID -> unit;
=DESCRIBE
ÿÛsubunit_infİüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	subunit_form
÷üüüüüüüüüüüüüüü
Ü	subunit_env' = {(block_name, ident)} á subunit_env
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function new\_scope\_proc\_inf}
=DOC
	val Ûnew_scope_proc_infİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_proc_infİüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag = speclabel_flag =
Ü	till_flag = body_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_proc\_form}
=DOC
	val Ûnew_scope_proc_formİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_proc_formİüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	formal_body_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = body_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub}
¹ZAX
Ü	Ûmake_moduleİ : Z_ID ¸ seq Z_PARA ­ seq Z_PARA
°
¹ZAX
Ü	Ûtrans_subunit_nameİ : ID ¸ ID ­ Z_ID
°
=DOC
val Ûmake_moduleİ : Z_ID -> unit;
val Ûtrans_subunit_nameİ : ID * ID -> Z_ID;
val Ûstubİ : unit -> unit;
=DESCRIBE
ÿÛstubİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	„Z_DOC;
Ü	ENV;
Ü	Subunit;
Ü	id1, id2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü 	¶mod_name : Z_ID·
Ü		mod_name = trans_subunit_name(id1, id2) ±
Ü		z' = make_module(mod_name, z) ë z ±
Ü 		zmod = ÊZ_MODULE;
Ü	subunit_env' = subunit_env  À {(id1, id2) í ÊSubunit};
Ü		subunit_flag''' = True ± id1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id1 = block_name'';
Ü	id2 = block_name';
Ü	specif_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507013	A stub called ?0 has already been introduced
=ENDDOC
\subsection{The SID function stub\_spec\_proc}
ÿÛFORM_PROCİüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Proc
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_procİ : FORMAL_PROC -> unit;
=DESCRIBE
ÿÛstub_spec_procİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_PROC;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	globs' = globals;
Ü	ÊIn_Scope' = subprog_flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function form\_proc}
=DOC
val Ûform_proc_pack_specİ : FORMAL_PROC -> unit;
=DESCRIBE
ÿÛform_proc_pack_specİüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_procs(ÊPackage, formal_procs À {ÊFormal_Proc})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
507076	Internal error: data structure for formal procedure is invalid
=ENDDOC
=DOC
val Ûform_proc_pack_body_commonİ : FORMAL_PROC ->
			(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) OPT
=DESCRIBE
ÿ Ûform_proc_pack_body_commonİüüüüüüüüüü
Ü	„Z_DOC; PACK_ENV; FORM_PROC; ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	Formal_Proc''';
Ü	Block';
Ü	Block'';
Ü	st : Statement;
Ü	pack_body_vars : ğ Var_Decl
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊPackage'''' = pack_env block_name'';
Ü	block_name'  {p : formal_procs'''' · p.name};
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab''''', st))¢;
Ü	ÊFormal_Proc'''  formal_procs''''; name''' = block_name';
Ü	fun_flag''''' = False;
Ü	vc_pars''''' = vc_pars'; vc_log_cons''''' = {};
Ü	vc_aux_vars''''' = (subprog_flatten_env(ÊENV)).vc_aux_vars \ aux_vars'''';
Ü	expand_schema_sigs (ran globals) \ w € expand_schema_sigs (ran globals''');
Ü	pack_body_vars = vc_vars'' \ vc_vars'''';
Ü	(		(st = spec_no_ivars(ÊSpec))
Ü		²	(st = spec_ivars(ÊSpec))
Ü	)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
507058	When a procedure is implemented, each variable in the list of global dependencies
	must be in the frame or global dependencies in the specification.
	?0 is not contained in ?1 in the specification of ?2
=ENDDOC
=DOC
val Ûform_proc_pack_bodyİ :
	(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) ->FORMAL_PROC -> 
		SPEC;
=DESCRIBE
ÿ Ûform_proc_pack_bodyİüüüüüüüüüüüüüü
Ü	form_proc_pack_body_common
÷üüüüüüüüüüüüüüü
Ü	(w'''  À expand_schema_sigs(ran globals''')) ¡ {a : aux_vars'''' · (Valueç~ê) a.zvar} = š;
Ü	w''''' = w''' À {v : pack_body_vars · trans_id v.var};
Ü	Pre''''' = Pre''';
Ü	post''''' = post''';
Ü	vc_vars''''' = (flatten_env(ÊENV)).vc_vars
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_pack_body_auxİ :
	(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) ->
	TERM list -> FORMAL_PROC -> SPEC;
=DESCRIBE
ÿ  Ûform_proc_pack_body_auxİüüüüüüüüüüüüüü
Ü	form_proc_pack_body_common;
Ü	ENV;
Ü	aux_vars, aux_vars0 : ğ Z_Decl;
Ü	conc_vars : ğ Var_Decl;
Ü	invs : ğ Z_PRED;
Ü	Spec'''''';
Ü	frame_aux_conc, frame_aux_conc0, add_aux, add_aux0 : ğ Z_ID;
Ü	seq_aux : seq Z_Decl
÷üüüüüüüüüüüüüüü
Ü	(w'''  À expand_schema_sigs(ran globals''')) ¡ {a : aux_vars'''' · (Valueç~ê) a.zvar} ½ š;
Ü	add_aux = {a : aux_vars'''' · (Valueç~ê) a.zvar} \ w''';
Ü	w'''''' = w''' À add_aux;
Ü	Pre'''''' = Pre''';
Ü	post'''''' =
Ü	z_many_and ({post'''} À
Ü	  {a : add_aux · z_eq(zid a, subs_exp(zid a, add_aux, add_aux0))});
Ü	aux_vars = {a : aux_vars'''' | (Valueç~ê) a.zvar  w''''''};
Ü	conc_vars = Ş {x : using_decs'' ¨ w''''''© · first x};
Ü	invs = {x : using_decs'' ¨ w''''''© · second x};
Ü	frame_aux_conc = w'''''' À {c : conc_vars · trans_id c.var};
Ü	# seq_aux = # aux_vars;
Ü	ran seq_aux = aux_vars0;
Ü	w''''' = frame_aux_conc À {v : pack_body_vars · trans_id v.var} \
Ü	  {a : aux_vars · (Valueç~ê) a.zvar};
Ü	Pre''''' = z_exists (aux_vars, z_many_and ({Pre''''''} À invs));
Ü	post''''' =
Ü	 z_forall (seq_aux, z_imp (subs_pred (z_many_and
Ü	  ({Pre''''''} À invs), frame_aux_conc, frame_aux_conc0),
Ü	  z_exists (aux_vars, z_many_and ({post''''''} À invs))));
Ü	vc_vars''''' = (subprog_flatten_env(ÊENV)).vc_vars À conc_vars
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_subunitİ : FORMAL_PROC -> unit;
=DESCRIBE
ÿ  Ûform_proc_subunitİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	„SUBUNIT_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name')} á subunit_env;
Ü	specif_flag''' = True;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab'''', st))¢;
Ü	ÊSpec'''' = specif''';
Ü	fun_flag'''' = False;
Ü	vc_vars'''' = vc_vars''';
Ü	vc_pars'''' = vc_pars' À vc_pars''';
Ü	vc_log_cons'''' = {}
Ü	vc_aux_vars'''' = vc_aux_vars''';
Ü	expand_schema_sigs(ran globals) \ w € expand_schema_sigs (ran globs''');
Ü	(	(st = spec_no_ivars(ÊSpec))
Ü	  ² 	(st = spec_ivars(ÊSpec))
Ü	)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_procİ : FORMAL_PROC -> unit;
=DESCRIBE
¹Z
Ü	Ûform_procİ ¦ 	form_proc_pack_spec ² form_proc_pack_body ²
Ü			form_proc_pack_body_aux ² form_proc_subunit 
°
=ENDDOC
\subsection{The SID function curr\_form\_proc}
=DOC
	val Ûcurr_form_procİ : FORMAL_PROC -> unit;
=DESCRIBE
ÿÛcurr_form_procİüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORM_PROC
÷üüüüüüüüüüüüüüü
Ü	blocks' =
Ü	blocks « {1 í Block_current_formal_proc(blocks 1, ÊFormal_Proc)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{FUNCTIONS}\label{FUNCTIONS}
\subsection{The SID function new\_scope\_fun\_inf}
=DOC
	val Ûnew_scope_fun_infİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_fun_infİüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	fun_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = declabel_flag = speclabel_flag =
Ü	till_flag = body_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_fun\_form}
=DOC
	val Ûnew_scope_fun_formİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_fun_formİüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	formal_body_flag = fun_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = body_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub\_spec\_fun}
ÿÛFORM_FUNİüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_funİ : FORMAL_FUN -> unit;
=DESCRIBE
ÿ  Ûstub_spec_funİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_FUN;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	ÊIn_Scope' = ÊIn_Scope;
Ü	globs' = globals
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function inf\_fun}
ÿÛINF_FUNİüüüüüüüüüüüüüüüüüüüüü
Ü	Informal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûinf_fun_declİ : INFORMAL_FUN -> Z_DECL * Z_ID;
=DESCRIBE
¹ZAX
Ü Ûinformal_functionİ : Z_ID
°
¹ZAX
Ü	Ûinf_fun_declİ : Informal_Fun ­ Z_Decl
÷üüüüüüüüüüüüü
Ü	µ Informal_Fun; Z_Decl·
Ü	inf_fun_decl (Ê Informal_Fun) = ÊZ_Decl ¤
Ü		zvar = Value(trans_id name) ±
Ü		zexp = zid(informal_function)
°
Since it is needed in $trans\_informal\_fun$, the ML coding of the
function returns the Z name as well as just the declaration.
=ENDDOC
=DOC
val Ûinf_fun_pack_specİ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿÛinf_fun_pack_specİüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	INF_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_informal_funs(ÊPackage, informal_funs ë §ÊInformal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûtrans_informal_funİ : INFORMAL_FUN -> ZParagraphs.PARAINFO;
=DESCRIBE
¹ZAX
Ü	Ûtrans_informal_funİ : Informal_Fun ­ Z_Ax
÷üüüüüüüüüüüüü
Ü	µf: Informal_Fun; Z_Ax·
Ü	trans_informal_fun f = ÊZ_Ax ¤ decls = {inf_fun_decl f} ± preds = {}
°
=ENDDOC
¹ZAX
Ü Ûadd_fun_axİ : (seq Z_PARA) ¸ Z_PARA ­ seq Z_PARA
÷üüüüüü
Ü µz : seq Z_PARA; para : Z_PARA·
Ü	para   ran z ± add_fun_ax(z, para) = z
Ü ²	para  ran z ± add_fun_ax(z, para) = z ë §para¢
°

=DOC
val Ûinf_fun_otherwiseİ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿÛinf_fun_otherwiseİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	INF_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = add_fun_ax(z, z_ax(trans_informal_fun(ÊInformal_Fun)))
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûinf_funİ : INFORMAL_FUN -> unit;
=DESCRIBE
¹Z
Ü	Ûinf_funİ ¦ inf_fun_pack_spec ² inf_fun_otherwise
°
=ENDDOC
\subsection{The SID function form\_fun}
=DOC
val Ûform_fun_pack_specİ : FORMAL_FUN -> unit;
=DESCRIBE
ÿÛform_fun_pack_specİüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_funs(ÊPackage, formal_funs ë §ÊFormal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûz_forall_optİ : (Z_DECL list * Z_PRED) -> Z_PRED;
=DESCRIBE
¹ZAX
Ü	Ûz_forall_optİ : (seq Z_Decl) ¸ Z_PRED ­ Z_PRED
÷üüüüüüüüüüüüü
Ü	µ zdecs: seq Z_Decl; zpred : Z_PRED; zres : Z_PRED·
Ü	z_forall_opt (zdecs, zpred) = zres ¤
Ü		zdecs = §¢ ± zres = zpred ²
Ü		zdecs ½ §¢ ± zres = z_forall(zdecs, zpred)
°
=ENDDOC
=DOC
val Ûfun_sigİ : (Z_EXP list * Z_EXP) -> Z_EXP;
val Ûpar_tmarkİ : CN_ENV -> PARAM_SPEC -> Z_ID list;
val Ûvar_sigİ : CN_ENV -> Z_ID -> Z_EXP;
val Ûfun_declİ : CN_ENV -> FORMAL_FUN -> Z_DECL;
=DESCRIBE
¹ZAX
Ü	Ûfun_sigİ : (seq Z_EXP) ¸ Z_EXP ­ Z_EXP
÷üüüüüüüüüüüüü
Ü	µ zpars : seq Z_EXP; zret : Z_EXP; zsig : Z_EXP·
Ü	fun_sig (zpars, zret) = zsig ¤
Ü		zpars = §¢ ± zsig = zret ²
Ü		zpars ½ §¢ ± zsig = z_tfun(z_many_cross zpars, zret)
°
¹ZAX
Ü	Ûpar_tmarkİ : Param_Spec ­ Z_ID
°
¹ZAX
Ü	Ûvar_sigİ : ENV ­ Z_ID ­ Z_EXP
°
¹ZAX
Ü	Ûfun_declİ : ENV ­ Formal_Fun ­ Z_Decl
÷üüüüüüüüüüüüü
Ü	µ env : ENV;  Formal_Fun; Z_Decl·
Ü	fun_decl env (Ê Formal_Fun) = ÊZ_Decl ¤
Ü		zvar = Value(trans_id name) ±
Ü		zexp = fun_sig(map (var_sig env) globals,
Ü				fun_sig(map (zid o par_tmark) formal_pars,
Ü					zid(trans_id return_type)))
°
The implementation of these functions are included as part of the VC generator as a) they are required there and b) this module depends on the VC generator. The names are included in this signature for traceability purposes.

$par\_tmark$ returns a list of type marks one for each parameter declared
in the $PARAM\_SPEC$ argument.
=ENDDOC
=DOC
val Ûz_par_declİ : PARAM_SPEC -> Z_DECL;
=DESCRIBE
¹ZAX
Ü	Ûz_par_declİ : Param_Spec ­ Z_Decl
°
=ENDDOC
=DOC
val Ûz_vars_of_envİ : CN_ENV -> Z_ID -> bool;
val Ûz_var_declİ : CN_ENV -> Z_ID -> Z_DECL;
=DESCRIBE
¹ZAX
Ü	Ûz_vars_of_envİ : ENV ­ ğZ_ID
÷
Ü µENV; zi : Z_ID· zi  z_vars_of_env (ÊENV) ¤
Ü	(¶i: dom blocks; Var_Decl·
Ü	ÊVar_Decl  (blocks i).vc_vars ± trans_id var = zi)
Ü ²	(¶i: dom blocks; Param_Spec·
Ü	ÊParam_Spec  (blocks i).vc_pars ± trans_id var = zi)
Ü ²	(¶i: dom blocks; Z_Decl[Z_EXP]·
Ü	ÊZ_Decl  (blocks i).vc_aux_vars ± zvar = Value zi)
°
¹ZAX
Ü	Ûz_var_declİ : ENV ­ Z_ID ­ Z_Decl
÷üüüüüüüüüüüüüüüüüü
Ü µenv: ENV; zname : Z_ID; Z_Decl·
Ü	z_var_decl env zname = ÊZ_Decl ¤
Ü	(zname  z_vars_of_env env ±
Ü	zvar = Value zname ±  zexp = var_sig env zname)
Ü	²
Ü	(zname  z_vars_of_env env ±
Ü	zvar = Nil ±  zexp = zid zname)
°
=ENDDOC
=DOC
val Ûtrans_formal_funİ : CN_ENV -> FORMAL_FUN -> ZParagraphs.PARAINFO * Z_PRED * Z_PRED;
=DESCRIBE
¹ZAX
Ü	Ûtrans_formal_funİ : ENV ­ Formal_Fun ß Z_Ax
÷üüüüüüüüüüüüü
Ü	µenv : ENV; Formal_Fun; Z_Ax·
Ü	trans_formal_fun env (ÊFormal_Fun) = ÊZ_Ax ¤
Ü		decls = {fun_decl env (ÊFormal_Fun)} ±
Ü		preds = {z_forall_opt(map (z_var_decl env) globals,
Ü				z_forall_opt(map z_par_decl formal_pars,
Ü					z_imp(Pre, post)))}
°
The ML function also returns the type-checked pre- and post-conditions.
=FAILURE
507067	Internal error: unexpected return value from trans_formal_fun
507068	The Z global variable ?0 has already been introduced and the
	declaration of function ?1 clashes with it
=ENDDOC
=DOC
val Ûtrans_formal_fun_nameİ : CN_ENV ->  PACKAGE OPT -> FORMAL_FUN -> Z_EXP;
=DESCRIBE
¹ZAX
Ü	Ûtrans_formal_fun_nameİ : Formal_Fun ß Z_EXP
°
¹ZAX
Ü	Ûsubs_exp_for_exp_in_predİ : Z_PRED ¸ Z_EXP ¸ Z_EXP ­ Z_PRED
°
=ENDDOC
=DOC
val Ûform_fun_pack_body_commonİ : FORMAL_FUN -> 
			(BLOCK * FORMAL_FUN * PACKAGE * SPECLAB) OPT
=DESCRIBE
ÿÛform_fun_pack_body_commonİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	ref : seq Z_PARA;
Ü	Formal_Fun''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' =add_fun_ax(z, z_ax(trans_formal_fun(ÊENV)(ÊFormal_Fun))) ë ref;
Ü	ÊPackage'''' = pack_env block_name'';
Ü	(
Ü		block_name'  {f : ran formal_funs'''' · f.name}
Ü	±	ref = §z_vcs(vcs(ÊSpeclab''''', st))¢
Ü	±	(st = spec_no_ivars(ÊSpec) ² st = spec_ivars(ÊSpec))
Ü	±	ÊFormal_Fun'''  ran formal_funs'''' ± name''' = block_name'
Ü	±	formal_body_flag''''' = True
Ü	±	fun_flag''''' = True
Ü	±	fun_header''''' = ÊInformal_Fun
Ü	±	vc_pars''''' = vc_pars' ± vc_log_cons''''' = {}
Ü	±	vc_vars''''' = (subprog_flatten_env(ÊENV)).vc_vars
Ü	±	vc_aux_vars''''' = (subprog_flatten_env(ÊENV)).vc_aux_vars \ aux_vars''''
Ü	)
Ü	²
Ü		(block_name'  {f : ran formal_funs'''' · f.name} ± ref = §¢)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_pack_bodyİ : 
	(BLOCK * FORMAL_FUN * PACKAGE * SPECLAB) -> FORMAL_FUN ->  unit;
=DESCRIBE
ÿÛform_fun_pack_bodyİüüüüüüüüüüüüüü
Ü	form_fun_pack_body_common
÷üüüüüüüüüüüüüüü
Ü	expand_schema_sigs(ran globals''') ¡ Value ç~ê ¨{ a : aux_vars''''·a.zvar}© = š;
Ü	globals = globals''';
Ü	Pre''''' = Pre''';
Ü	post''''' = post'''
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507050	When a function is implemented in a package body,
	unless the formal function in the package specification ontains auxiliary variables, 
	the list of global dependencies in the package body
	must be the same as in the package specification. ?0 does not agree with
	?1 in the specification of ?2
=ENDDOC
=DOC
val Ûform_fun_pack_body_auxİ : 
	(BLOCK * FORMAL_FUN * PACKAGE * SPECLAB) -> 
	TERM list -> FORMAL_FUN ->  unit;
=DESCRIBE
ÿÛform_fun_pack_body_auxİüüüüüüüüüüüüüü
Ü	form_fun_pack_body_common;
Ü	aux_vars : ğZ_Decl;
Ü	invs : ğZ_PRED;
Ü	seq_aux : seq Z_Decl;
Ü	afunc, cfunc : Z_EXP;
Ü	conc_ids : ğID
÷üüüüüüüüüüüüüüü
Ü	expand_schema_sigs(ran globals''') ¡ Value ç~ê ¨{ a : aux_vars''''·a.zvar}© = š;
Ü	aux_vars = {a : aux_vars'''' | (Valueç~ê) a.zvar  expand_schema_sigs(ran globals''')};
Ü	invs = {x : using_decs'' ¨  expand_schema_sigs(ran globals''') © · second x};
Ü	conc_ids =  {d : Ş {x : using_decs'' ¨  expand_schema_sigs(ran globals''') © · first x} · d.var} À
Ü		trans_id  ç~ê ¨expand_schema_sigs(ran globals''') \ Value ç~ê ¨ {a : aux_vars· a.zvar}© ©;
Ü	#seq_aux = #aux_vars;
Ü	ran seq_aux = aux_vars;
Ü	afunc = trans_formal_fun_name(ÊFormal_Fun''');
Ü	cfunc = trans_formal_fun_name(ÊFormal_Fun);
Ü	Pre''''' = z_exists (aux_vars, z_many_and ({Pre'''} À invs));
Ü	post''''' =
Ü	 z_forall (seq_aux, z_imp (z_many_and ({Pre'''} À invs),
Ü	  z_exists (aux_vars,
Ü	    z_many_and ({subs_exp_for_exp_in_pred(post''', afunc, cfunc)} À invs))))
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
507095	When a function is implemented in a package body, if the 
	formal function in the package specification contains auxiliary variables,
	then each variable in the list of global dependencies in the package body
	must either appear in the global dependency list in the package specification or must be a using
	variable implementing one of the auxiliary variables in the specification.
	?0 in the specification of ?1 violates this rule.
=ENDDOC
=DOC
val Ûform_fun_subunitİ : FORMAL_FUN -> unit;
=DESCRIBE
ÿ Ûform_fun_subunitİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	„SUBUNIT_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	ref : seq Z_PARA;
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = add_fun_ax(z, z_ax(trans_formal_fun(ÊENV)(ÊFormal_Fun))) ë ref;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name')} á subunit_env;
Ü		specif_flag''' = True
Ü	±	ref = §z_vcs(vcs(ÊSpeclab'''', st))¢
Ü	±	(st = spec_no_ivars(ÊSpec) ² st = spec_ivars(ÊSpec))
Ü	±	ÊSpec'''' = specif''' ± formal_body_flag'''' = True
Ü	±	fun_flag'''' = True
Ü	±	fun_header'''' = ÊInformal_Fun ± vc_vars'''' = {}
Ü	±	vc_pars'''' = vc_pars' À vc_pars''' ± vc_log_cons'''' = {}
Ü	±	vc_aux_vars''' = {} ± globals = globs'''
Ü	²
Ü		specif_flag''' = False ± ref = §¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_otherwiseİ : FORMAL_FUN -> unit;
=DESCRIBE
ÿÛform_fun_otherwiseİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	FORM_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = pack_body_flag'' = subunit_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = add_fun_ax(z, z_ax(trans_formal_fun(ÊENV)(ÊFormal_Fun)))
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûform_funİ : FORMAL_FUN -> unit;
=DESCRIBE
¹Z
Ü	Ûform_funİ ¦ 	form_fun_pack_spec ² form_fun_pack_body ²
Ü			form_fun_pack_body_aux ² form_fun_subunit ² form_fun_otherwise
°
=ENDDOC
\subsection{The SID function curr\_form\_fun}
=DOC
	val Ûcurr_form_funİ : FORMAL_FUN -> unit;
=DESCRIBE
ÿÛcurr_form_funİüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORM_FUN
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_current_formal_fun(blocks 1, ÊFormal_Fun)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{FORMAL PARAMETERS}\label{FORMALPARAMETERS}
ÿÛFORMALSİüüüüüüüüüüüüü
Ü	formals : ğ Param_Spec
ˆüüüüüüüüüüüüüüüüü
\subsection{The SID function formal\_part}
=DOC
	val Ûfformal_partİ : PARAMETER_SPECIFICATION list -> unit;
=DESCRIBE
ÿÛformal_partİüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORMALS
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, formals)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{SUBPROGRAM BODIES}\label{SUBPROGRAMBODIES}
\subsection{The SID function update\_envs\_proc}
=DOC
	val Ûupdate_subunit_env_procİ : unit -> unit;
=DESCRIBE
ÿÛupdate_subunit_env_procİüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s'
Ü	·	dec_lab''  s.dec_labels ±
Ü		s' =
Ü		Subunit_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab''  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_procİ : unit -> unit;
=DESCRIBE
ÿÛupdate_dec_env_procİüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'
Ü	·	dec_lab''  d.dec_labels ±
Ü		d' =
Ü		Declab_formal_procs(d, d.formal_procs À {current_formal_proc'})
Ü	²	dec_lab''  d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_procİ : unit -> unit;
=DESCRIBE
ÿÛupdate_spec_env_procİüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'
Ü	·	dec_lab''  s.dec_labels ±
Ü		s' =
Ü		Speclab_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab''  s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_procİ : unit -> unit;
=DESCRIBE
¹Z
Ü Ûupdate_envs_procİ ¦ update_subunit_env_proc ± update_dec_env_proc
Ü			± update_spec_env_proc
°
=ENDDOC
\subsection{The SID function add\_proc\_env}
=DOC
	val Ûadd_proc_envİ : unit -> unit;
=DESCRIBE
ÿÛadd_proc_envİüüüüüüü
Ü	„ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	blocks' =
Ü	blocks « {2 í Block_formal_procs(ÊBlock'',
Ü			formal_procs'' À {current_formal_proc'})}
ˆüüüüüüüüüüüüüüü
=FAILURE
507066	A declaration for procedure ?0 has already been processed;
	the specification statements in the two declarations do not agree
=ENDDOC
\subsection{The SID function subprogram\_implementation}
=DOC
	val Ûsubprogram_implementationİ : unit -> unit;
=DESCRIBE
ÿÛsubprogram_implementationİüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORMALS
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_body_flag(blocks 1, True)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\subsection{The SID function vcs\_body}
ÿÛSEQ_STMTSİüüüü
Ü	st : Statement
ˆüüüüüüüüüüü
=DOC
	val Ûvcs_body_procİ : STATEMENT -> SPEC;
=DESCRIBE
ÿ Ûvcs_body_procİüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Proc';
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_proc' = ÊFormal_Proc';
Ü	Pre = z_many_and({Pre'} À
Ü	Ş{v : dom var_inits'; ze : Z_EXP; tm : TMARK
Ü	 | ze = trans_exp(first(var_inits' v)) ± tm = second(var_inits' v)·
Ü		{z_eq(zid(trans_id v), slide_to_tmark(ze, tm))} À domain_conds ze});
Ü	post = post';
Ü	fun_flag = False;
Ü	return = post';
Ü	ÊIn_Scope = subprog_flatten_env(ÊENV);
Ü	w = w' À {v : vc_vars' · trans_id v.var}
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûvcs_body_funİ : STATEMENT -> SPEC;
=DESCRIBE
ÿÛvcs_body_funİüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Fun';
Ü	Block'
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_fun' = ÊFormal_Fun';
Ü	w = {v : vc_vars' · trans_id (v.var)};
Ü	Pre = z_many_and({Pre'} À
Ü	Ş{v : dom var_inits'; ze : Z_EXP; tm : TMARK
Ü	 | ze = trans_exp(first(var_inits' v)) ± tm = second(var_inits' v)·
Ü		{z_eq(zid(trans_id v), slide_to_tmark(ze, tm))} À domain_conds ze});
Ü	post = post';
Ü	formal_body_flag = fun_flag = True;
Ü	fun_header= ÊInformal_Fun';
Ü	return = post';
Ü	ÊIn_Scope = subprog_flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=ENDDOC
=DOC
	val Ûvcs_bodyİ : STATEMENT -> unit;
=DESCRIBE
¹Z
Ü	Ûvcs_bodyİ ¦ vcs_body_proc ² vcs_body_fun
°
=ENDDOC
\section{PACKAGES}\label{PACKAGES}
\subsection{The SID function new\_scope\_pack\_spec}
=DOC
	val Ûempty_packageİ : CONTEXT_COMPILATION_UNIT -> PACKAGE;
=DESCRIBE
ÿÛEmpty_Packageİüüüüüüü
Ü	Package
÷üüüüüüüü
Ü	vc_vars = {};
Ü	consts_types = §¢;
Ü	formal_procs = {};
Ü	informal_funs = §¢;
Ü	formal_funs = §¢;
Ü	aux_vars = {}
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûnew_scope_pack_specİ : ID -> DECLARATION PACKAGE_DECLARATION -> unit;
=DESCRIBE
ÿÛnew_scope_pack_specİüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Empty_Block;
Ü	Empty_Package
÷üüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = True;
Ü	pack_body_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = body_flag = False;
Ü	pack_env' = pack_env À {ident í ÊPackage}
ˆüüüüüüüüüüüüüüü
=FAILURE
507007	The name ?0 has already been used for a package
=ENDDOC
\subsection{The SID function new\_scope\_pack\_body}
=DOC
	val Ûnew_scope_pack_bodyİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_pack_bodyİüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_PARENTS;
Ü	IDENT;
Ü	PACK_ENV;
Ü	Block;
Ü	Block';
Ü	Package'
÷üüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	(subunit_flag' = False ±
Ü		parents = {zmod'.mod_name} ± z' = z ë §z_parents(ÊZ_PARENTS)¢ ²
Ü	 subunit_flag' = True ± z' = z);
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = pack_env ident;
Ü	block_name = ident;
Ü	pack_body_flag = body_flag = True;
Ü	pack_spec_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = {};
Ü	formal_procs = {};
Ü	dec_labels = {};
Ü	using_decs = {}
ˆüüüüüüüüüüüüüüü
=FAILURE
=ENDDOC
\pagebreak
\subsection{The SID function new\_scope\_with}
¹ZAX
Ü	Ûnew_idsİ : Package ­ ğ ID
÷üüüüüüüüüüüüüü
ÜµPackage·
Ü	new_ids(ÊPackage) = 
Ü	{v : vc_vars · v.var} À
Ü	{c : Const_Decl | const_decl c  ran consts_types · c.const} À
Ü	{t : Type_Decl | type_decl t  ran consts_types · t.name} À
Ü	{ident : ID; Type_Decl; Enum_Type_Def |
Ü		type_decl(ÊType_Decl)  ran consts_types ±
Ü		type_def = enum_type_def(ÊEnum_Type_Def) ±
Ü		ident  ran vals · ident} À
Ü	{s : Subtype_Decl | subtype_decl s  ran consts_types · s.name} À
Ü	{p : formal_procs · p.name} À
Ü	{f : ran informal_funs · f.name} À
Ü	{f : ran formal_funs· f.name}
°
¹ZAX
Ü	Ûprefixİ : (ID ¸ ğID ¸ Package) ­ Package
°
¹ZAX
Ü	Ûz_prefixİ : (ID ¸ ğID ¸ Z_MODULE) ­ seq Z_PARA
°
=DOC
	val Ûnew_scope_withİ : ID -> unit;
=DESCRIBE
ÿ Ûnew_scope_withİüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_MODULE;
Ü	Z_PARENTS;
Ü	IDENT;
Ü	PACK_ENV;
Ü	Block;
Ü	Package';
Ü	Z_DOC''
÷üüüüüüüü
Ü	ident  dom pack_env;
Ü	z_module(Ê Z_MODULE)  ran z;
Ü	z' = z'' ë z ë §z_parents(Ê Z_PARENTS)¢;
Ü	z'' = z_prefix(ident, new_ids(pack_env ident), (pack_env ident).zmod) ë
Ü		map (trans_informal_fun » z_ax) informal_funs'ë
Ü		map (trans_formal_fun (ÊENV)» z_ax) formal_funs';
Ü	head z'' = z_module(Ê Z_MODULE);
Ü	parents = {mod_name};
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = prefix(ident, new_ids(pack_env ident), pack_env ident);
Ü	pack_body_flag = pack_spec_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag =
Ü	speclabel_flag = till_flag = body_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = aux_vars';
Ü	formal_procs = formal_procs';
Ü	dec_labels = {}
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûpackage_idsİ : ID -> ID list;
=DESCRIBE
This is the composite of a look-up in the package environment and {\it new\_ids}
for the convenience of checking use clauses in the SPARK output function.
If there is no package environment entry, an empty list is returned (and checks
made in the Z Generator will have raised an exception unless the package was
introduced via an arbitrary replacement).
=ENDDOC
\subsection{The SID function update\_envs\_pack\_spec}
=DOC
	val Ûupdate_envs_pack_specİ : ID -> unit;
=DESCRIBE
ÿ Ûupdate_envs_pack_specİ üüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Block';
Ü	In_Scope;
Ü	IDENT;
Ü	PACK_ENV;
Ü	Package''
÷üüüüüüüü
Ü	body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	blocks' = blocks « {1 í Block_in_scope(ÊBlock', ÊIn_Scope)};
Ü	z' = z ë z_prefix(ident, new_ids(pack_env ident), (pack_env ident).zmod) ;
Ü	ÊPackage'' = prefix(ident, new_ids(pack_env ident), pack_env ident);
Ü	vc_vars = vc_vars' À vc_vars'';
Ü	vc_pars = vc_pars';
Ü	vc_log_cons = vc_log_cons';
Ü	vc_aux_vars = vc_aux_vars' À aux_vars'';
Ü	formal_procs = formal_procs' À formal_procs'';
Ü	dec_labels = dec_labels'
ˆüüüüüüüüüüüüüüü
=FAILURE
507060	Internal error: the package environment entry for ?0 has gone missing
=ENDDOC
\subsection{The SID function end\_scope\_comp\_unit}
=DOC
val Ûend_scope_comp_unitİ : unit -> unit;
=DESCRIBE
ÿÛend_scope_comp_unitİüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = §blocks 1¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function aux\_var}
$AUX\_VAR$ is declared in \cite{ISS/HAT/DAZ/DTD502}.
=DOC
val Ûaux_varİ : AUX_VAR -> unit;
=DESCRIBE
ÿ Ûaux_varİ üüüüüüüüüüü
Ü	„PACK_ENV;
Ü	AUX_VAR;
Ü	„ENV;
Ü	Package;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	 pack_env «
Ü	 {block_name' í Package_aux_vars(ÊPackage, aux_vars À {aux})};
Ü	blocks' =
Ü	blocks « {1 í Block_vc_aux_vars(ÊBlock', vc_aux_vars' À {aux})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507032	Declaration of ?0 has already been introduced 
=ENDDOC
\subsection{The SID function using\_dec}
$USING\_DEC$ is declared in \cite{ISS/HAT/DAZ/DTD502}.
=DOC
val Ûusing_decİ : USING_DEC -> unit;
=DESCRIBE
ÿÛusing_decİüüüüüüüüüüü
Ü	„ENV;
Ü	USING_DEC;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' =
Ü	 blocks «
Ü	 {1 í
Ü	  Block_using_decs
Ü	   (blocks 1, using_decs' À {aux í (concrete_vars, invariant)})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function vcs\_aux\_initial}
=DOC
val Ûvcs_aux_initialİ : STATEMENT -> SPEC;
=DESCRIBE
ÿÛvcs_aux_initialİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	PACK_ENV;
Ü	Block';
Ü	Speclab
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë § z_vcs (vcs (ÊSpeclab, st))¢;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = {};
Ü	formal_procs = formal_procs';
Ü	fun_flag = False;
Ü	w = {v : vc_vars' · trans_id v.var};
Ü 	Pre = z_many_and(
Ü        {v : dom var_inits'; ze : Z_EXP; tm : TMARK
Ü	 | ze = trans_exp(first(var_inits' v)) ± tm = second(var_inits' v)
Ü	 · z_eq(zid(trans_id v), slide_to_tmark(ze, tm))});
Ü	post =
Ü	 z_exists
Ü	 ((pack_env block_name').aux_vars,
Ü	 z_many_and {x : ran using_decs' · second x})
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{RENAMING DECLARATIONS AND USE CLAUSES}\label{RENAMINGDECLARATIONS}
\subsection{The SID function renames\_proc}
ÿÛRENAMES_NEWİüüüüüüüüüüü
Ü	new:ID;
Ü	formal_pars : seq Param_Spec
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
ÿÛRENAMES_OLDİüüüüüüüüüüü
Ü	pack : OPT[ID];
Ü	old:ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüü

=DOC
val Ûrenames_proc_commonİ : FORMAL_PROC list -> SUBPROGRAM_RENAMING -> FORMAL_PROC OPT;
=DESCRIBE
ÿÛrenames_proc_commonİüüüüüüüüüüü
Ü	ENV;
Ü	PACK_ENV;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD;
Ü	Package;
Ü	Block';
Ü	Formal_Proc'';
Ü	Formal_Proc'''
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	(¶n: ID· pack = Value n ±
Ü		name'' = n dot old ±
Ü		ÊPackage = prefix(n, new_ids(pack_env n), pack_env n))
Ü ²	(pack = Nil ±
Ü		name'' = old ± formal_procs = (flatten_env(ÊENV)).formal_procs);
Ü	ÊFormal_Proc''  formal_procs;
Ü	name''' = new;
Ü	formal_ids''' = formal_ids'';
Ü	globals''' = globals'';
Ü	ÊSpec''' = ÊSpec''
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûrenames_proc_pack_specİ : SUBPROGRAM_RENAMING -> unit;
val Ûrenames_proc_otherwiseİ : SUBPROGRAM_RENAMING -> unit;
val Ûrenames_procİ : SUBPROGRAM_RENAMING -> unit;
=DESCRIBE
ÿ Ûrenames_proc_pack_specİ üüüüüüüüüüü
Ü „PACK_ENV;
Ü renames_proc_common;
Ü Package''
÷üüüüüü
Ü pack_spec_flag' = True;
Ü pack_env block_name' = ÊPackage'';
Ü pack_env' =
Ü pack_env «  { block_name' í
Ü   Package_formal_procs(ÊPackage'', formal_procs'' À {ÊFormal_Proc'''})}
ˆüüüüüüüüüüüüüü

ÿ Ûrenames_proc_otherwiseİ üüüüüüüüüüü
Ü „ENV;
Ü renames_proc_common
÷üüüüüü
Ü pack_spec_flag' = False;
Ü blocks' = blocks « { 1 í
Ü    Block_formal_procs(ÊBlock', formal_procs' À {ÊFormal_Proc'''})}
ˆüüüüüüüüüüüüüü
¹Z
Ü Ûrenames_procİ ¦ renames_proc_pack_spec ² renames_proc_otherwise
°

=FAILURE
507059	The renaming declaration for ?0 as ?1  cannot be handled formally
	(either ?0 is not a formal subprogram or the renaming declaration is not
	consistent with its declaration)
507061	The renaming declaration for ?0 as ?1  cannot be handled formally
	(package ?1 has already been processed)
507062	The renaming declaration for ?0 as ?1  cannot be handled formally
	(package ?0 has not been processed)
507063	The use clause for package ?0 cannot be handled formally
	(package ?0 has not been processed)
507064	The renaming declaration for ?0 as ?1  cannot be handled formally
	(either ?0 has not been processed formally or ?1 is already in scope
	or the declaration for ?1 is not compatible with that of ?0)
507073	The use clause for package ?0 cannot be handled formally (?1)
507074	The renaming declaration for package ?0 as ?1 cannot be handled formally (?2)
507075	The required abbreviation definition ?0 = ?1 is incompatible with the existing definition
=ENDDOC
\subsection{The SID function renames\_fun}

=DOC
val Ûrenames_funİ : SUBPROGRAM_RENAMING -> unit;
=DESCRIBE
ÿÛrenames_funİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD
÷üüüüüüü
Ü	(¶n: ID· pack = Value n ±
Ü		z' = z ë §z_eq_eq(trans_id new, zid(trans_id(n dot old)))¢)
Ü ²	(pack = Nil ±
Ü		z' = z ë §z_eq_eq(trans_id new, zid(trans_id old))¢)
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function renames\_opsym}
=DOC
val Ûrenames_opsymİ : OPSYM_RENAMING -> unit;
=DESCRIBE
¹ZAX
Ü Ûresolve_opsymİ : ID ¸ seq Param_Spec ­ Z_EXP
°

ÿÛrenames_opsymİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD
÷üüüüüüü
Ü	z' = z ë §z_eq_eq(trans_id new, resolve_opsym (new, formal_pars))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function renames\_object}
ÿÛrenames_var_commonİüüüüüüüüüüü
Ü	„ENV;
Ü	PACK_ENV;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD;
Ü	zname' : Z_ID;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü ¶In_Scope; n : ID; zname : Z_ID · ÊIn_Scope = flatten_env(ÊENV)
Ü ±	(	pack = Nil ± zname = trans_id old
Ü	²	pack = Value n ± zname  = trans_id (n dot old) )
Ü ±	(	zname'  {v : vc_vars· trans_id (v.var)} À {a : vc_aux_vars· (Valueç~ê) a.zvar}
Ü	±	zname = zname'
Ü	²	zname í zname'  var_renamings )
Ü ±	blocks' =
Ü	blocks « {1 í  Block_var_renamings(blocks 1, var_renamings À {trans_id new í zname'})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü

ÿ Ûrenames_var_pack_specİ üüüüüüüüüüü
Ü „PACK_ENV;
Ü renames_var_common;
Ü Package''
÷üüüüüü
Ü pack_spec_flag' = True;
Ü pack_env block_name' = ÊPackage'';
Ü pack_env' =
Ü pack_env «  { block_name' í
Ü   Package_var_renamings(ÊPackage'', var_renamings'' À {trans_id new í zname'})}
ˆüüüüüüüüüüüüüü

ÿ Ûrenames_var_otherwiseİ üüüüüüüüüüü
Ü renames_var_common
÷üüüüüü
Ü pack_spec_flag' = False
ˆüüüüüüüüüüüüüü
¹Z
Ü Ûrenames_varİ ¦  renames_var_pack_spec ² renames_var_otherwise
°

ÿÛrenames_constİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	PACK_ENV;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD
÷üüüüüüü
Ü ¶In_Scope; n : ID; zname : Z_ID · ÊIn_Scope = flatten_env(ÊENV)
Ü ±	(	pack = Nil ± zname = trans_id old
Ü	²	pack = Value n ± zname  = trans_id (n dot old) )
Ü ±	(	zname  {v : vc_vars· trans_id (v.var)} À {a : vc_aux_vars· (Valueç~ê) a.zvar}
Ü	±	zname  dom var_renamings )
Ü ±	z' = z ë §z_eq_eq(trans_id new, zid zname)¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
¹Z
Ü Ûrenames_objectİ ¦ renames_var_pack_spec ² renames_var
°
\subsection{The SID function renames\_pack}
¹ZAX
Ü Ûrename_basic_declİ : ID ­ BASIC_DECL ­ Z_PARA
÷üüüüüü
Ü µpack : ID; Const_Decl·
Ü	rename_basic_decl pack (const_decl(ÊConst_Decl)) = 
Ü	z_eq_eq(trans_id const, zid(trans_id(pack dot const)));
Ü µpack : ID; Type_Decl·
Ü	rename_basic_decl pack (type_decl(ÊType_Decl)) =
Ü	z_eq_eq(trans_id name, zid(trans_id(pack dot name)));
Ü µpack : ID; Subtype_Decl·
Ü	rename_basic_decl pack (subtype_decl(ÊSubtype_Decl)) =
Ü	z_eq_eq(trans_id name, zid(trans_id(pack dot name)))
°
¹ZAX
Ü Ûrename_formal_funİ : ID ­ Formal_Fun ­ Z_PARA
÷üüüüüü
Ü µpack : ID; Formal_Fun·
Ü	rename_formal_fun pack (ÊFormal_Fun) =
Ü	z_eq_eq(trans_id name, zid(trans_id(pack dot name)))
°

ÿÛrenames_pack_consts_types_funsİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	IDENT;
Ü	Package
÷üüüüüüü
Ü	z' =
Ü	z ë rename_basic_decl ident o consts_types ë rename_formal_fun ident o formal_funs
ˆüüüüüüüüüüüüüüüüüüüüüüüüü

ÿÛrenames_pack_procsİüüüüüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Package;
Ü	envs : seq ğENV;
Ü	pack_envs : seq ğPACK_ENV;
Ü	fps : seq Formal_Proc
÷üüüüüüü
Ü	envs 1 = {ÊENV};
Ü	ÊENV'  envs(#envs) ;
Ü	pack_envs 1 = {ÊPACK_ENV};
Ü	ÊPACK_ENV'  pack_envs(#pack_envs);
Ü	#envs = #pack_envs = #fps + 1 = #formal_procs + 1;
Ü	ran fps = formal_procs;
Üµ i : dom fps·¶ envs i; (envs(i+1))'; pack_envs i; (pack_envs(i+1))'; renames_proc·
Ü	pack = Value ident ± old = (fps i).name ± new = (fps i).name
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
ÿÛrenames_pack_varsİüüüüüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Package;
Ü	envs : seq ğENV;
Ü	pack_envs : seq ğPACK_ENV;
Ü	vds : seq Var_Decl
÷üüüüüüü
Ü	envs 1 = {ÊENV};
Ü	ÊENV'  envs(#envs) ;
Ü	pack_envs 1 = {ÊPACK_ENV};
Ü	ÊPACK_ENV'  pack_envs(#pack_envs);
Ü	#envs = #pack_envs = #vds + 1 = #formal_procs + 1;
Ü	ran vds = vc_vars;
Üµ i : dom vds·¶ envs i; (envs(i+1))'; pack_envs i; (pack_envs(i+1))'; renames_var[opack/pack]·
Ü	opack = Value ident ± old = (vds i).var ± new = (vds i).var
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
¹ZAX
Ü Ûuntrans_idİ : Z_ID ­ ID
÷üüüüüü
Ü  µzi : Z_ID· trans_id(untrans_id zi) = zi
°
ÿÛrenames_pack_aux_varsİüüüüüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Package;
Ü	envs : seq ğENV;
Ü	pack_envs : seq ğPACK_ENV;
Ü	avs : seq Z_Decl
÷üüüüüüü
Ü	envs 1 = {ÊENV};
Ü	ÊENV'  envs(#envs) ;
Ü	pack_envs 1 = {ÊPACK_ENV};
Ü	ÊPACK_ENV'  pack_envs(#pack_envs);
Ü	#envs = #pack_envs = #avs + 1 = #formal_procs + 1;
Ü	ran avs = aux_vars;
Üµ i : dom avs·¶ envs i; (envs(i+1))'; pack_envs i; (pack_envs(i+1))'; renames_var[opack/pack]·
Ü	opack = Value ident ±
Ü	old =untrans_id((Valueç~ê)(avs i).zvar) ±
Ü	new = untrans_id((Valueç~ê)(avs i).zvar)
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
ÿÛrenames_packİüüüüüüüüüüü
Ü	renames_pack_consts_types_funs»‰s
Ü	renames_pack_procs»‰s
Ü	renames_pack_vars»‰s
Ü	renames_pack_aux_vars
÷üüüüüüü
Ü	ÊPackage = pack_env ident
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
¹Z
Ü Ûuse_packİ ¦ renames_pack
°

\section{STUBS AND SUBUNITS}\label{STUBSANDSUBUNITS}

\subsection{The SID function begin\_stub}
=DOC
val Ûbegin_stubİ : unit -> unit;
=DESCRIBE
ÿÛbegin_stubİüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks 1, True)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function end\_stub}
=DOC
val Ûend_stubİ : unit -> unit;
=DESCRIBE
ÿÛend_stubİüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks 1, False)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_subunit}
=DOC
val Ûnew_scope_subunitİ : ID -> unit;
=DESCRIBE
ÿÛnew_scope_subunitİüüüüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	subunit_flag = body_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function pack\_stub}
=DOC
val Ûpack_stubİ : ID -> unit;
=DESCRIBE
ÿ Ûpack_stubİ üüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	„Z_DOC;
Ü	ENV;
Ü	Subunit;
Ü	id1 : ID;
Ü	Block';
Ü	Block'';
Ü	IDENT
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü 	¶mod_name : Z_ID·
Ü		mod_name = trans_subunit_name(id1, ident) ±
Ü		z' = make_module(mod_name, z) ë z ±
Ü 		zmod = ÊZ_MODULE;
Ü	subunit_env' = subunit_env  À {(id1, ident) í ÊSubunit};
Ü		subunit_flag'' = True ± id1 = block_name'' dot block_name'
Ü	²	subunit_flag'' = False ± id1 = block_name';
Ü	subunit_env' = subunit_env  À {(id1, ident) í ÊSubunit};
Ü	specif_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü

=ENDDOC

\section{WEB CLAUSES}\label{WEBCLAUSES}
\subsection{The SID function z\_copy}
ÿÛZPARAİüüüüüüüüüüü
Ü	zpara : Z_PARA
ˆüüüüüüüüüüüüüüü
ÿÛz_copyİüüüüüüüüüüü
Ü	„Z_DOC;
Ü	ZPARA
÷üüüüüüü
Ü	z' = z ë §zpara¢
ˆüüüüüüüüüüüüüüü
\subsection{The SID function new\_scope\_dec\_replace}
=DOC
val Ûnew_scope_dec_replaceİ : REPLACED_BY_DECL -> unit;
=DESCRIBE
ÿÛnew_scope_dec_replaceİüüüüüüüüüüü
Ü	„ENV;
Ü	„DEC_ENV;
Ü	LAB;
Ü	Block
÷üüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	ÊDeclab = Declab_declabel_flag(dec_env label, True);
Ü	dec_lab = label;
Ü	dec_env' = {label} á dec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507002	?0 has not been introduced as a declaration label
=ENDDOC

\subsection{The SID function update\_envs\_remove\_declabel}
=DOC
	val Ûupdate_subunit_env_remove_declabelİ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿÛupdate_subunit_env_remove_declabelİüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		s' = Subunit_dec_labels (s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_remove_declabelİ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿÛupdate_dec_env_remove_declabelİüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		d' = Declab_dec_labels(d, d.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_remove_declabelİ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿÛupdate_spec_env_remove_declabelİüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		s' = Speclab_dec_labels(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_remove_declabelİ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
Ü		Ûupdate_envs_remove_declabelİ
Ü	¦	update_subunit_env_remove_declabel
Ü	±	update_dec_env_remove_declabel
Ü	±	update_spec_env_remove_declabel
°
=ENDDOC
\subsection{The SID function new\_scope\_speclabel}
=DOC
	val Ûnew_scope_speclabelİ: LABEL -> unit
=DESCRIBE
ÿÛnew_scope_speclabelİüüüüüüüüüüüüüü
Ü	„ENV;
Ü	LAB;
Ü	SPEC_ENV;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	speclabel_flag = True;
Ü	till_flag = (spec_env label).till_flag;
Ü	pack_spec_flag = pack_body_flag = stub_flag =
Ü	subunit_flag = formal_body_flag = fun_flag =
Ü	declabel_flag = body_flag = False;
Ü	spec_lab = label;
Ü	till = (spec_env label).till
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?0 has not been introduced
=ENDDOC
\subsection{The SID function vcs\_speclabel}
=DOC
	val Ûvcs_speclabelİ: REFINED_BY -> SPEC
=DESCRIBE
ÿÛvcs_speclabelİüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	SEQ_STMTS;
Ü	SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(spec_env spec_lab', st))¢	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü

=ENDDOC
\subsection{The SID function end\_scope\_speclabel}
=DOC
	val Ûend_scope_speclabelİ: unit -> unit
=DESCRIBE
ÿÛend_scope_speclabelİüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	end_scope;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = {spec_lab'} á spec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID functions new\_scope\_stmtlabel and end\_scope\_stmt\_label}
=DOC
	val Ûnew_scope_stmt_labelİ: LABEL -> unit
	val Ûend_scope_stmt_labelİ: unit -> unit
=DESCRIBE
¹Z
Ü	Ûnew_scope_stmt_labelİ ¦ new_scope_speclabel
°
¹Z
Ü	Ûend_scope_stmt_labelİ ¦ end_scope_speclabel
°
=ENDDOC

\newpage
\section{SPARK PROGRAM ENVIRONMENT}
The SPARK program environment enables the SPARK program to be recovered.
The relevant data structures are described in \cite{ISS/HAT/DAZ/DTD513}.
 
To describe the manipulation of this environment, we use some additional SID functions.

\subsection{The SID Function update\_replacement\_env}

This is called at the following points in the syntax.

=GFT
web_clause =
	z,
	compilation <update_spark_prog>,
	comp_label replacedby compilation <update_replacement_env>,
	ppart_label replacedby private_part <update_replacement_env>,
	vpart_label replacedby visible_part <update_replacement_env>,
	dec_label replacedby dec dp1 <update_replacement_env>,
	stmt_label replacedby sequence_of_statements <update_replacement_env>,
	spec_label refinedby sequence_of_statements <update_replacement_env>,
	refinedby sequence_of_statements <update_replacement_env>,
	spec_label replacedby sequence_of_statements <update_replacement_env>,
	replacedby sequence_of_statements <update_replacement_env>;
=TEX
(The manipulation of the replacement environment does not interact with the other SID functions, and so the interleaving of calls to $update\_replacement\_env$ and the other SID functions is immaterial).

The global variable $REPL$ holds the right-hand side of the current replacement or refinement web clause:

ÿREPLüüüüüüüüüüüüüü
Ü	repl : Replacement
ˆüüüüüüüüüüüüüüüüü
The global variable $COMP$ holds the current k-slot or compilation unit web clause:

ÿCOMPüüüüüüüüüüüüüü
Ü	comp : K_Slot_Compilation_Unit
ˆüüüüüüüüüüüüüüüüü

$update\_replacement\_env$ adds the maplet mapping the current label (in the global variable $LAB$) to $REPL$ to the replacement environment.
=DOC
val Ûupdate_replacement_envİ : LABEL * REPLACEMENT -> unit
=DESCRIBE
ÿupdate_replacement_envüüüüüüüüüüüüüü
Ü	„REPL_ENV;
Ü	LAB;
Ü	REPL
÷üüüüüüüüüüüüüüü
Ü	repl_env' = repl_env « {label í repl}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûupdate_spark_progİ : KSLOT_COMPILATION_UNIT list -> unit
=DESCRIBE
$update\_spark\_prog$ appends the current compilation to the sequence of same held in the SPARK program environment.

ÿupdate_spark_progüüüüüüüüüüüüüü
Ü	„SPARK_Prog;
Ü	COMP
÷üüüüüüüüüüüüüüü
Ü	spark' = spark ë §comp¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?0 has not been introduced
507004	label ?0 has already been refined or replaced
507005	label ?0 has already been used
=ENDDOC
\newpage
\section{INTERFACE}
=DOC
val Ûget_z_generator_stateİ : unit -> Z_GENERATOR_STATE
val Ûset_z_generator_stateİ : Z_GENERATOR_STATE -> unit
val Ûdiag_z_generator_stateİ : Z_GENERATOR_STATE ref
val Ûdiag_web_clauseİ : WEB_CLAUSE ref;
val Ûdiag_basic_decl_listİ : BASIC_DECL list ref;
val Ûdiag_vc_argsİ : (SPECLAB * STATEMENT) list ref;
val Ûkslot_compilation_unit_nameİ : KSLOT_COMPILATION_UNIT -> string;
val Ûadd_spark_type_infoİ : ID * (ID list * int) -> unit;
val Ûcurrent_cn_envİ : CN_ENV;
type ÛCN_EXCEPTION_LOGİ = string list S_DICT;
val Ûget_exception_logsİ : unit ->  CN_EXCEPTION_LOG;
val Ûdelete_exception_logİ : string -> unit; 
val Ûlog_messageİ : string -> unit;
val Ûlog_exceptionİ : exn -> string;
=DESCRIBE
=ENDDOC
=DOC
val Ûclassify_labelİ : string -> REPL_SORT OPT
val Ûget_replacementİ : string -> REPLACEMENT OPT
val Ûdo_web_clauseİ : CNTypes.WEB_CLAUSE -> unit
=DESCRIBE
=ENDDOC

=DOC
type ÛCN_STATEİ
val Ûget_cn_stateİ : unit -> CN_STATE
val Ûset_cn_stateİ : CN_STATE -> unit
val Ûinitial_cn_stateİ : CN_STATE
val Ûnew_scriptİ : {name : string, state : CN_STATE} -> unit
val Ûnew_script1İ :
	{name : string, state : CN_STATE, library_theories : string list} -> unit
val Ûnew_continuation_scriptİ : {name : string, state : CN_STATE} -> unit
val Ûnew_continuation_script1İ :
	{name : string, state : CN_STATE, library_theories : string list} -> unit
val Ûcn_z_generatorİ : CNTypes.WEB_CLAUSE -> unit
val Ûsco_z_generatorİ : CNTypes.WEB_CLAUSE -> unit
val Ûrestart_cn_z_generatorİ : unit -> unit
val Ûget_script_theoriesİ : string -> string list
val Ûget_saved_cn_stateİ : string -> CN_STATE;
val Ûdelete_scriptİ : string -> unit;
=DESCRIBE
$new\_script1$ acts the same as $new\_script$ except that its list
of library theories will be made the parents of the script theory,
and any theory produced during processing the script.	
=ENDDOC

\section{VC Browser Information Interface} 
=DOC
val Ûget_vc_context_routeİ : string * (string -> string) -> vc_context_route;
val Ûdest_routeİ : ROUTE -> (TERM * vc_route_arg);
=DESCRIBE
Information about VCs is stored as a \textit{\slshape USER\_DATUM} and extracted with 
\textit{\slshape get\_vc\_context\_route}.
=FAILURE
507085	Unexpected term in VC route.
507086	Case branch count out of int range.
507087	Unexpected term when elsf indicator expected.
507088	Unexpected structure of contexts and routes. 
=ENDDOC
\section{Additional Error Messages} 
=DOC
(* additional error messages *)
=DESCRIBE
Split a long list to keep documentation tidy.
=FAILURE
507017	Representation clauses are not handled formally and may affect the meaning of the program
507018	Pragmas are not handled formally and may affect the meaning of the program
507019	Internal error: unexpected abstract syntax category encountered
507021	Deferred constant declarations are not handled formally
507023	Cannot introduce theory ?0; a declaration for package
	?1 has probably already been processed
507024	Cannot introduce theory ?0; a body for package
	?1 has probably already been processed
507025	Cannot introduce theory ?0; a main program called
	?1 may already have been processed
507026	Cannot introduce theory ?0; a stub for the subunit
	?1 may already have been processed
507027	Cannot open theory ?0; a stub for the subunit
	?1 has not been processed
507028	Cannot open theory ?0; a declaration for the package
	?1 has not been processed
507029	Design error: information required for package ?0 has vanished
507030	Cannot introduce package body: a specification for package ?0 has not been processed
507034	Cannot make theory ?0 a parent of theory ?1: ?2
507035	Cannot make theory ?0 a parent of theory ?1: theory ?0 does not exist
507036	This renaming declaration cannot be handled formally 
	(?0 is not a formal procedure)
507038	A specification for package ?0 has not been processed
507039	Arbitrary Ada replacements may violate VC soundness
507070	There is no script called ?0 in the current state database
507071	When a package is referred to in a USE clause or a RENAMING clause
	its declaration must be complete; 
	package ?0 is not complete; it contains the following unexpanded label?1
507072	Unable to check package ?0 (missing or corrupt table entry for script ?1)
507079	Internal error: corrupt table entry for script ?1
507089	The declarations in a block statement can only be handled formally
	if the block statement appears on its own on the right-hand side of
	a refinement or replacement step.
=ENDDOC
=DOC
(* additional error messages *)
=DESCRIBE
Split a long list to keep documentation tidy.
=FAILURE
507040	A specification for package ?0 is not allowed here because the
	theory ?1 already exists (perhaps because a specification for
	the package has already been processed)
507042	Library theory ?0 cannot be made a parent of the script theory: ?1
507044	This renaming declaration cannot be handled formally
	(?0 not successfully processed because ?1)
507045	A script may not contain more than one compilation unit:
	cannot add compilation unit ?0 to script ?1 as it already contains
	compilation unit ?2.
507046	DESIGN ERROR: Corrupt compilation unit data for theory ?0
507047	DESIGN ERROR: Should be called in theory ?0 but currently in ?1
507048	?0 appear to be one or more SPARK functions from the same package
	specification that specifies function ?1, which may not be used
	in the specification of that function
507053	Free variable ?0 found in checking predicate ?1 of formal procedure
507054	Free variables ?0 found in checking predicate ?1 of formal procedure
507055	Formal parameter ?0 in package ?1 clashes with a name declared in
	package that must be prefixed.
507056	Compilation units may only be added to theories created for that purpose:
	compilation unit ?0 cannot be added to theory ?1 
507057	Unable to provide prefixed specifications for ?0
507065	?0 is not a valid label here
507069	Internal error: unexpected environment renaming entry (old name: ?0, new name: ?1)
507077	An assertion may only appear in a refinement step or in the body of a formal subprogram
507078	Internal error: corrupt default parameter information
507081	To be handled formally, default expressions in parameter specifications must be constant expressions.
	The Z expression ?0 contains the free variable ?1
507082	To be handled formally, default expressions in parameter specifications must be constant expressions.
	The Z expression ?0 contains the free variables ?1
507090	The theory ?0 is locked and so cannot be deleted
507091	Deleting script ?0 has caused the following to be deleted:
507092	Script theories:?0Other theories:?1Subunits?2Packages:?3
507093	The theory ?0 is an ancestor of the current theory and so cannot be deleted
507094	The theory ?0 is in an ancestor database and so cannot be deleted
507100	*** SOUNDNESS WARNING : ?2 [?1.?0]
507101	*** Z GENERATION FAILURE: ?0
507121	The free variables in the post-condition of a specification statement must be in scope.
	The post-condition ?0 contains the
	free variable ?1 that is not in scope
507122	The free variables in the post-condition of a specification statement must be in scope.
	The post-condition ?0 contains the
	free variables ?1 that are not in scope
507123	The free variables in the pre-condition of a specification statement must be in scope.
	The pre-condition ?0 contains the
	free variable ?1 that is not in scope
507124	The free variables in the pre-condition of a specification statement must be in scope.
	The pre-condition ?0 contains the
	free variables ?1 that are not in scope
507125	Free variables are not allowed in VCs.
	The VC ?0 contains the free variable ?1
	(this variable does not appear free in the pre- or post-condition of
	the specification statement being refined)
507126	Free variables are not allowed in VCs.
	The VC ?0 contains the free variables ?1
	(these variables do not appear free in the pre- or post-condition of
	the specification statement being refined)
507127	?0 is not a valid type mark
507128	Internal error: invalid Z type associated with type mark ?0
507129	The identifier ?0 is not in scope
507130	Internal error: attempt to look up ?0 in an empty environment
507131	Internal error: inconsistent use of environment dictionary entry for ?0
=ENDDOC
=DOC
(* additional error messages *)
=DESCRIBE
=FAILURE
=ENDDOC
\section{EPILOGUE}
=SML
end; (* signature CNZGenerator *)
=TEX
\section{TEST POLICY}
The functions in this document do not lend themselves to module testing (as discussed in \cite{ISS/HAT/DAZ/HLD503}). Testing of the design and implementation of the Z document generator will be done using suitable integration tests.

Testing will be in accordance with the criteria identified in \cite{ISS/HAT/DAZ/PLN003}.

\small
\twocolumn[\section{INDEX}]
\printindex

\end{document}



