%  dtd507.doc %Z% $Date$ $Revision$ $RCSfile$
=TEX
% TQtemplate.tex
\documentstyle[hol1,11pt,TQ]{article}
\ftlinepenalty=9999
\def\Hide#1{}
\def\Bool{``$\it{:}bool\,$''}
\makeindex
\TPPproject{DAZ PROJECT}  %% Mandatory field
%\TPPvolume{}
%\TPPpart{}
\TPPtitle{Detailed Design: Z Generator}  %% Mandatory field
\TPPref{ISS/HAT/DAZ/DTD507}  %% Mandatory field
\def\SCCSversion{$Revision$%
}
\TPPissue{\SCCSversion}  %% Mandatory field
\TPPdate{\FormatDate{$Date$%
}}
%\TPPstatus{Approved}
\TPPstatus{Draft}
\TPPtype{Specification}
\TPPkeywords{SPARK}
\TPPauthor{R.D.~Arthan&WIN01}
\TPPauthorisation{D.J.~King & DAZ Team Leader}
\TPPabstract{
This document contains the detailed design for the
Compliance Notation Specification Database.}
%\TPPabstractB{}
%\TPPabstractC{}
%\TPPabstractD{}
%\TPPabstractE{}
%\TPPabstractF{}
\TPPdistribution{\parbox[t]{4.0in}{%
	Library}}

%\TPPclass{CLASSIFICATION}
%\def\TPPheadlhs{}
%\def\TPPheadcentre{}
%def\TPPheadrhs{}
%\def\TPPfootlhs{}
%\def\TPPfootcentre{}
%\def\TPPfootrhs{}

\begin{document}
\TPPsetsizes
\makeTPPfrontpage

\vfill
\begin{centering}

\bf Copyright \copyright\ : International Computers Ltd \number\year

\end{centering}

\newpage
\section{DOCUMENT CONTROL}
\subsection{Contents List}
\tableofcontents
\subsection{Document Cross References}
\bibliographystyle{fmu}
\bibliography{fmu,hatdocs,daz}

\subsection{Changes History}  % to get section number `0.3'
\begin{description}
\item[Issue \SCCSversion~\FormatDate{$Date$%
}) ] Initial Draft.

\end{description}
\subsection{Changes Forecast}
\section{GENERAL}
\subsection{Scope}
This document contains the detailed design for the functions whose Z specification is given in in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0}; it is called for in \cite{ISS/HAT/DAZ/HLD503}.
Sections \ref{BASICDECLARATIONS}-\ref{WEBCLAUSES} contain the design and correspond directly with sections 4-15 of the DRA specification.

\subsection{Introduction}
This document gives the structure (i.e., module) containing the functions defined \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0}.
This covers the main semantic processing involved in the extraction of a Z document from a Compliance Notation script.
As usual it also includes a transcription into {\ProductZ} of the relevant parts of the DRA specification.

The overall effect of the processing defined here is to update the {\Product} theory database as if the Z document had been loaded into it and to update internal state representing the environments of  \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0} as implemented in \cite{ISS/HAT/DAZ/DTD513}.
The internal state also includes additional information defined in \cite{ISS/HAT/DAZ/DTD513} and used to record the association of k-slot labels with SPARK program fragments.
This gives all the information required to reduce extraction of the Z document and of the SPARK program to straightforward pretty-printing tasks.

\subsubsection{Purpose and Background}
See \cite{ISS/HAT/DAZ/HLD503}.


\subsubsection{Dependencies}
See \cite{ISS/HAT/DAZ/HLD503}.
%\subsubsection{Possible Enhancements}
\subsubsection{Deficiencies}
None known.

\section{DESIGN ISSUES}
\section{PREAMBLE}
=DOC
signature ÛCNZGeneratorÝ = sig
=DESCRIBE
=ENDDOC

=SML
local
open	CNTypes CNTypes1 CNTypes2 ZParagraphs;
in
=TEX
\section{BASIC DECLARATIONS}\label{BASICDECLARATIONS}
\subsection{The SID Function basic\_declaration}
ÿBASIC_DECLüüüüüüüüüüüüüüüüüüüüü
Ü	basic_decl : BASIC_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûbasic_decl_pack_specÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_consts_types(ÊPackage, consts_types ë §basic_decl¢ }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_decl_otherwiseÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_otherwiseüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	z' =
Ü	z ë trans_basic_decl basic_decl
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_declarationÝ : BASIC_DECL -> unit;
=DESCRIBE
¹Z
	basic_declaration ¦ basic_decl_pack_spec ² basic_decl_otherwise
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function var\_pack\_spec}
ÿVAR_DECLüüüüüüüüüüüüüüüüüüüüü
Ü	vars : ð VAR_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûvar_pack_specÝ : VAR_DECL -> unit;
=DESCRIBE
In the implementation, variable declarations contain lists of identifiers, rather than single identifiers (i.e., they are as in the concrete syntax rather than the Z abstract syntax).
We therefore only deal with a single $VAR\_DECL$ here.
ÿvar_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	VAR_DECL;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_vc_vars(ÊPackage, vc_vars À vars }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function update\_envs\_var}
=DOC
val Ûupdate_subunit_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_subunit_env_varüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Subunit_vc_vars(s, s.vc_vars À vars) ²
Ü		decl_lab' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_dec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_dec_env_varüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		dec_lab'  d.dec_labels ±
Ü		d' = Declab_vc_vars(d, d.vc_vars À vars) ²
Ü		dec_lab' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_spec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_spec_env_varüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Declab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Speclab_w
Ü		(Spec_lab_vc_vars(s, s.vc_vars À vars),
Ü		s.w À {v : vars· trans_if (v.var}) ²
Ü		dec_lab' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_envs_varÝ : VAR_DECL -> unit;
=DESCRIBE
¹Z
		update_envs_var
	¦	update_subunit_env_var
	±	update_dec_env_var
	±	update_spec_env_var
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function add_var_env}
=DOC
val Ûupdate_subunit_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿadd_var_envüüüüüüüüüüüüüü
Ü	„ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' = blocks « {1 í Block_vc_vars(blocks 1, vc_vars' À vars)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{DECLARATIONS}\label{DECLARATIONS}
\subsection{The SID function k\_slot\_dec}
ÿLABüüüüüüüüüüüü
Ü	label : LABEL
ˆüüüüüüüüüüüüüü
¹ZAX
Ü	no_label
°
¹Z
fun 6 _dot_
°
¹ZAX
Ü	_dot_: (ID ¸ ID) ­ ID
°
=DOC
val Ûk_slot_decÝ : LABEL -> unit;
=DESCRIBE
ÿk_slot_decüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	LAB;
Ü	ENV;
Ü	Declab;
Ü	Block';
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	dec_env' = dec_env À {label í ÊDeclab};
Ü	subunit_flag'' = True ± block_name = block_name'' dot block_name' ²
Ü	subunit_flag'' False ± block_name = block_name';
Ü	ÊFlags = ÊFlags';
Ü	ÊIn_scope = flatten_env(ÊEnv)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
507010	?0 is already in use as a declaration label
=ENDDOC

\section{STATEMENTS}\label{STATEMENTS}
\subsection{The SID function spec\_stmt}
ÿSPEC_STMTüüüüüüüüüüüü
Ü	specification : SPEC
ˆüüüüüüüüüüüüüü
=DOC
val Ûspec_stmt_speclabelÝ : SPEC -> unit;
=DESCRIBE
ÿspec_stmt_speclabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	SPEC_STMT;
Ü	LAB;
Ü	ENV;
Ü	Speclab;
Ü	Speclab'';
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = spec_env À {label í ÊSpeclab};
Ü	ÊSpeclab'' = spec_env spec_lab';
Ü	ÊSpec = specification;
Ü	formal_body_flag = formal_body_flag'';
Ü	fun_flag = fun_flag'';
Ü	till_flag = till_flag';
Ü	fun_header = fun_header'';
Ü	return = return'';
Ü	till = till';
Ü	vc_vars = vc_vars'';
Ü	vc_pars = vc_pars'' À (flatten_env(ÊENV)).vc_pars;
Ü	vc_log_cons = vc_log_cons'' À vc_log_cons';
Ü	formal_procsx = formal_procs'';
Ü	dec_labels = dec_labels''
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507014	specification label ?0 has not been introduced
507015	label ?0 has already been introduced
=ENDDOC
=DOC
val Ûspec_stmt_otherwiseÝ : SPEC -> unit;
=DESCRIBE
ÿspec_stmt_otherwiseüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	SPEC_STMT;
Ü	LAB;
Ü	ENV;
Ü	Speclab;
Ü	Formal_Fun';
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = spec_env À {label í ÊSpeclab};
Ü	ÊSpec = specification;
Ü	formal_body_flag = formal_body_flag';
Ü	fun_flag = fun_flag';
Ü	till_flag = till_flag';
Ü	current_formal_fun = ÊFormal_fun';
Ü	fun_header = Ê	Informal_Fun;
Ü	return =post';
Ü	till = till';
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function k\_slot\_stmt}
=DOC
val Ûk_slot_stmtÝ : LABEL -> unit;
=DESCRIBE
¹Z
	k_slot_stmt ¦ spec_stmt
°
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function add\_log\_con\_env}
ÿLOGICAL_CONüüüüüüüüü
Ü	logical_con : Z_Decl
ˆüüüüüüüüüüüüüüüü
=DOC
val Ûadd_log_con_envÝ : LOG_CON -> unit;
=DESCRIBE
ÿadd_log_con_envüüüüüüüüüüü
Ü	„ENV;
Ü	LOGICAL_CON
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, {logical_con})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûremove_log_con_envÝ : unit -> unit;
=DESCRIBE
ÿremove_log_con_envüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, {})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{LOOPS}\label{LOOPS}=DOC
\subsection{The SID function new\_scope\_loop}
=DOC
	val Ûnew_scope_scope_loopÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_loopüüüüüüüü
Ü	„ENV;
Ü	Empty_Block;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊBlock' = blocks 1;
Ü	block_name = ident;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	declabel_flag = till_flag = false;
Ü	fun_flag = fun_flag';
Ü	speclabel_flag = speclabel_flag';
Ü	current_formal_proc = current_formal_proc';
Ü	current_formal_fun = current_formal_fun';
Ü	spec_lab = spec_lab'
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\subsection{The SID function end\_scope}

=DOC
val Ûend_scopeÝ : unit -> unit;
=DESCRIBE
ÿend_scopeüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = tail blocks
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
=ENDDOC
\subsection{The SID function for\_param}
ÿFOR_PARAMüüüüüüüüüüü
Ü	Param_Spec
÷üüüüüüü
Ü	mode = in
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûfor_paramÝ : ID -> unit;
=DESCRIBE
ÿfor_paramüüüüüüüüüüüüü
Ü	„ENV;
Ü	FOR_PARAM
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, {ÊParam_Spec})}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function till\_pred}
ÿTILL_PREDüüüüüüüüüüü
Ü	till : Z_PRED
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûtill_predÝ : Z_PRED -> unit;
=DESCRIBE
ÿfor_paramüüüüüüüüüüüüü
Ü	„ENV;
Ü	TILL_PRED
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_till(Block_till_flag(blocks 1, True), till)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\section{SUBPROGRAM DECLARATIONS}\label{SUBPROGRAMDECLARATIONS}
The SID function $end\_scope$ used in processing these has already been defined in section \ref{LOOPS}.
\section{PROCEDURES}\label{PROCEDURES}
\subsection{The SID function subunit\_form}
ÿIDENTüüüüüüüüüüüüüüüüüüüüü
Ü	ident : ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûsubunit_formÝ : ID -> unit;
=DESCRIBE
ÿsubunit_formüüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	SUBUNIT_ENV;
Ü	IDENT;
Ü	„BLOCK;
Ü	Subunit'
÷üüüüüüüüüüüüüüü
Ü	subunit_flag = True;
Ü	ÊBlock = head blocks;
Ü	blocks' = blocks « {1 í ÊBlock'};
Ü	z' = z ë §z_module zmod'¢;
Ü	ÊSubunit' = subunit_env(block_name, ident);
Ü	block_name' = block_name;
Ü	ÊFlags' = ÊFlags;
Ü	ÊIn_Scope' = ÊIn_Scope
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	Internal error: entry for ?0 missing from subunit environment
=ENDDOC
\subsection{The SID function subunit\_inf}
ÿIDENTüüüüüüüüüüüüüüüüüüüüü
Ü	ident : ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûsubunit_infÝ : ID -> unit;
=DESCRIBE
ÿsubunit_infüüüüüüüü
Ü	SUBUNIT_ENV;
Ü	subunit_form
÷üüüüüüüüüüüüüüü
Ü	subunit_env' = {(block_name, ident)} á subunit_env
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	Internal error: entry for ?0 missing from subunit environment
=ENDDOC
\subsection{The SID function new\_scope\_proc\_inf}
=DOC
	val Ûnew_scope_proc_infÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_proc_infüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag = speclabel_flag =
Ü	till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_proc\_form}
=DOC
	val Ûnew_scope_proc_formÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_proc_formüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	formal_body_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub}
¹Z
Ü	make_module : Z_DOC ­ Z_MODULE
°
=DOC
val ÛstubÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿstubüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	Z_DOC;
Ü	ENV;
Ü	Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env' = subunit_env  À {(id‰1, id‰2) í ÊSubunit)};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	zmod = make_module : Z_DOC ­ Z_MODULE;
Ü	specif_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊEnv)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507013	A stub called ?0 has already been introduced
=ENDDOC
\subsection{The SID function stub\_spec\_proc}
ÿFORM_PROCüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Proc
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_procÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿstub_spec_procüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_PROC;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	ÊIn_Scope' = ÊIn_Scope
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	Internal error: entry for ?0 missing from subunit environment
=ENDDOC
\subsection{The SID function form\_proc}
=DOC
val Ûform_proc_pack_specÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿform_proc_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_procs(ÊPackage, formal_procs ë §ÊInformal_Proc¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_pack_bodyÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿform_proc_pack_bodyüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	PACK_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	Formal_Proc''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊPackage'''' = pack_env block_name'';
Ü		block_name'  {f : ran formal_funs''' · f.name}
Ü	±	z' = z ë §z_vcs(vcs(ÊSpeclab''''', st)¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊFormal_Proc''  ran formal_procs'''' ± name''' = block_name'
Ü	±	ÊSpec''''' = ÊSpec''' ± fun_flag''''' = False
Ü	±	vc_vars''''' = vc_vars''''
Ü	±	vc_pars''''' = vc_pars' ± vc_log_cons''''' = {}
Ü	²
Ü		block_name' Ž {f : ran formal_procs''' · f.name} ± ref = §¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_subunitÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿform_fun_subunitüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	SUBUNIT_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name'} á subunit_env;
Ü		specif_flag''' = True
Ü	±	z' = z ë §z_vcs(vcs(ÊSpeclab'''', st)¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊSpec'''' = specif''' ± fun_flag'''' = False
Ü	±	vc_vars'''' = vc_vars3
Ü	±	vc_pars'''' = vc_pars' ± vc_log_cons'''' = {}
Ü	²
Ü		specif_flag''' = False ± z' = z
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_procÝ : FORMAL_PROC -> unit;
=DESCRIBE
¹Z
	form_proc ¦ 	form_proc_pack_spec ² form_proc_pack_body ²
			form_proc_subunit 
°
=ENDDOC
\section{FUNCTIONS}\label{FUNCTIONS}
\subsection{The SID function new\_scope\_fun\_inf}
=DOC
	val Ûnew_scope_fun_infÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_fun_infüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	fun_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = declabel_flag = speclabel_flag =
Ü	till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_fun\_form}
=DOC
	val Ûnew_scope_fun_formÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_fun_formüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	fun_flag = formal_body_flag True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub\_spec\_fun}
ÿFORM_FUNüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_funÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿstub_spec_funüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_FUN;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	ÊIn_Scope' = ÊIn_Scope
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	Internal error: entry for ?0 missing from subunit environment
=ENDDOC
\subsection{The SID function inf\_fun}
ÿINF_FUNüüüüüüüüüüüüüüüüüüüüü
Ü	Informal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûcart_prodÝ : PARAM_SPEC list -> Z_EXP;
=DESCRIBE
¹ZAX
Ü	cart_prod : seq‰1 Param_Spec ß Z_EXP
°
=FAILURE
507009	Internal error: unexpected nil argument
=ENDDOC
=DOC
	val Ûfun_declÝ : INFORMAL_FUN -> Z_DECL;
=DESCRIBE
¹ZAX
Ü	fun_decl : Informal_Fun ­ Z_Decl
÷üüüüüüüüüüüüü
Ü	µf: Informal_Fun; Z_Decl·
Ü	fun_decl f = ÊZ_Decl ¤
Ü		formal_pars = §¢ ± zvar = trans_id name ±
Ü		zexp = zid(trans_id return_type) ²
Ü		formal_pars ½ §¢ ± z zvar = trans_id name ±
Ü		zexp = z_tfun(cart_prod formal_pars, zid(trans_id return_type))
°
=ENDDOC
=DOC
val Ûinf_fun_pack_specÝ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿinf_fun_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	INF_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_informal_funs(ÊPackage, informal_funs ë §ÊInformal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûtrans_informal_funÝ : INFORMAL_FUN -> PARAINFO;
=DESCRIBE
¹ZAX
Ü	trans_informal_fun : Informal_Fun ­ Z_Ax
÷üüüüüüüüüüüüü
Ü	µf: Informal_Fun; Z_Ax·
Ü	trans_informal_fun f = ÊZ_Ax ¤ decls = {fun_decl f} ± preds = {}
°
=ENDDOC
=DOC
val Ûinf_fun_otherwiseÝ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿinf_fun_otherwiseüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	INF_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_informal_fun(ÊInformal_Fun))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûinf_funÝ : INFORMAL_FUN -> unit;
=DESCRIBE
¹Z
	inf_fun ¦ inf_fun_pack_spec ² inf_fun_otherwise
°
=ENDDOC
\subsection{The SID function form\_fun}
=DOC
val Ûform_fun_pack_specÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_funs(ÊPackage, formal_funs ë §ÊInformal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûz_declsÝ : PARAM_SPEC list -> Z_DECL list;
=DESCRIBE
¹ZAX
Ü	z_decls : seq‰1 Param_Spec ß seq‰1 Z_Decl
°
=ENDDOC
=DOC
val Ûtrans_formal_funÝ : FORMAL_FUN -> PARAINFO;
=DESCRIBE
¹ZAX
Ü	trans_formal_fun : Formal_Fun ­ Z_Ax
÷üüüüüüüüüüüüü
Ü	µFormal_Fun; Z_Ax·
Ü	trans_formal_fun (ÊFormal_Fun) = ÊZ_Ax ¤
Ü		decls = {fun_decl (ÊInformal_Fun)} ±
Ü			(formal_pars = §¢ ± preds = {z_imp(pre, post)} ²
Ü			formal_pars ½ §¢ ±
Ü			preds = {z_forall(z_decls formal_pars, z_imp(pre, post))}
°
=ENDDOC
=DOC
val Ûform_fun_pack_bodyÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_pack_bodyüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	ref : seq Z_PARA;
Ü	Formal_Fun''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_informal_fun(ÊFormal_Fun))¢ ë ref;
Ü	ÊPackage'''' = pack_env block_name'';
Ü		block_name'  {f : ran formal_funs''' · f.name}
Ü	±	ref = §z_vcs(vcs(ÊSpeclab''''', st)¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊFormal_Fun''  ran formal_funs'''' ± name''' = block_name'
Ü	±	ÊSpec''''' = ÊSpec''' ± fun_flag''''' = True
Ü	±	fun_header''''' = ÊInformal_Fun ± vc_vars''''' = {}
Ü	±	vc_pars''''' = vc_pars' ± vc_log_cons''''' = {}
Ü	²
Ü		block_name' Ž {f : ran formal_funs''' · f.name} ± ref = §¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_subunitÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_subunitüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	„SUBUNIT_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	ref : seq Z_PARA;
Ü	Formal_Fun''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_formal_fun(ÊFormal_Fun))¢ ë ref;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name'} á subunit_env;
Ü		specif_flag''' = True
Ü	±	ref = §z_vcs(vcs(ÊSpeclab'''', st)¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊSpec'''' = specif''' ± fun_flag'''' = True
Ü	±	fun_header'''' = ÊInformal_Fun ± vc_vars'''' = {}
Ü	±	vc_pars'''' = vc_pars' ± vc_log_cons'''' = {}
Ü	²
Ü		specif_flag''' = False ± ref = §¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_otherwiseÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_otherwiseüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	FORM_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = pack_body_flag'' = subunit_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_formal_fun(ÊFormal_Fun))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûform_funÝ : FORMAL_FUN -> unit;
=DESCRIBE
¹Z
	form_fun ¦ 	form_fun_pack_spec ² form_fun_pack_body ²
			form_fun_subunit ² form_fun_otherwise
°
=ENDDOC
\subsection{The SID function curr\_form\_fun}

\section{FORMAL PARAMETERS}\label{FORMALPARAMETERS}
ÿFORMALSüüüüüüüüüüüüü
Ü	formals : ð Param_Spec
ˆüüüüüüüüüüüüüüüüü
\subsection{The SID function formal\_part}
=DOC
	val Ûformal_partÝ : PARAMETER_SPECIFICATION list -> unit;
=DESCRIBE
ÿformal_partüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORMALS
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, formals)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{SUBPROGRAM BODIES}\label{SUBPROGRAMBODIES}
\subsection{The SID function update\_envs\_proc}
=DOC
	val Ûupdate_subunit_env_procÝ : unit -> unit;
=DESCRIBE
ÿupdate_subunit_env_procüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s'
Ü	·	dec_lab''  s.dec_labels ±
Ü		s' =
Ü		Subunit_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_procÝ : unit -> unit;
=DESCRIBE
ÿupdate_dec_env_procüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'
Ü	·	dec_lab''  d.dec_labels ±
Ü		d' =
Ü		Declab_formal_procs(d, d.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DESCRIBE
	val Ûupdate_spec_env_procÝ : unit -> unit;
=DOC
ÿupdate_spec_env_procüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Declab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'
Ü	·	dec_lab''  s.spec_labels ±
Ü		s' =
Ü		Speclab_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž s.spec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function add\_proc\_env}
=DOC
	val Ûadd_proc_envÝ : unit -> unit;
=DESCRIBE
ÿadd_proc_envüüüüüüü
Ü	„ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	block' =
Ü	blocks « {2 í Block_formal_procs(ÊBlock'',
Ü			formal_procs'' À {current_formal_proc'})}
ˆüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function vcs\_body}
ÿSEQ_STMTSüüüü
Ü	st : Statement
ˆüüüüüüüüüüü
=DOC
	val Ûvcs_body_procÝ : STATEMENT -> unit;
=DESCRIBE
ÿvcs_body_procüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Proc';
Ü	Block'
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_proc' = ÊFormal_Proc';
Ü	w = w‰1 À {v : vc_vars' · trans_id (v.var)};
Ü	Pre = pre';
Ü	post = post';
Ü	fun_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûvcs_body_funÝ : STATEMENT -> unit;
=DESCRIBE
ÿvcs_body_funüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Fun';
Ü	Block'
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_fun' = ÊFormal_Fun';
Ü	w = {v : vc_vars' · trans_id (v.var)};
Ü	Pre = pre';
Ü	post = post';
Ü	formal_body_flag = fun_flag = True;
Ü	fun_header= ÊInformal_Fun';
Ü	return = post';
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûvcs_bodyÝ : STATEMENT -> unit;
=DESCRIBE
¹Z
	vc_body ¦ vc_body_proc ² vcs_body_fun
=ENDDOC
\section{PACKAGES}\label{PACKAGES}
\subsection{The SID function new\_scope\_pack\_spec}
=DOC
	val Ûempty_packageÝ : PACKAGE;
=DESCRIBE
ÿEmpty_Packageüüüüüüü
Ü	Package
÷üüüüüüüü
Ü	vc_vars = {};
Ü	consts_types = §¢;
Ü	formal_procs = {};
Ü	informal_funs = §¢;
Ü	formal_funs = §¢
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûnew_scope_pack_specÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_pack_pecüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Empty_Block;
Ü	Empty_Package
÷üüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = True;
Ü	pack_body_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False;
Ü	pack_env' = pack_env À {ident í ÊPackage}
ˆüüüüüüüüüüüüüüü
=FAILURE
507007	The name ?0 has already been used for a package
=ENDDOC
\subsection{The SID function new\_scope\_pack\_body}
=DOC
	val Ûnew_scope_pack_bodyÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_pack_bodyüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	IDENT;
Ü	„PACK_ENV;
Ü	Block;
Ü	Package'
÷üüüüüüüü
Ü	z' = z ë ë/ (map trans_basic_decl consts_types');
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = pack_env ident;
Ü	block_name = ident;
Ü	pack_body_flag = True;
Ü	pack_spec_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = §¢;
Ü	formal_procs = {};
Ü	formal_procs = {};
Ü	dec_labels = {}
ˆüüüüüüüüüüüüüüü
=FAILURE
507008	No package specification for package ?0 has been declared
=ENDDOC
\subsection{The SID function new\_scope\_with}
¹ZAX
Ü	new_ids : Package ­ ð ID
÷üüüüüüüüüüüüüü
ÜµPackage·
Ü	new_ids(ÊPackage) = 
Ü	{v : vc_vars · v.var} À
Ü	{c : Const_Decl | const_decl c  ran const_types · c.const} À
Ü	{t : Type_Decl | type_decl t  ran const_types · t.name} À
Ü	{ident : ID; Type_Decl; Enum_Type_Def |
Ü		type_decl(ÊType_Decl)  ran consts_types ±
Ü		type_def = enum_type_def(ÊEnum_Type_Def) ±
Ü		ident  ran vals · ident} À
Ü	{s : Subtype_Decl | subtype_decl s  ran consts_types · s.name} À
Ü	{p : formal_Procs· p.name} À
Ü	{f : ran informal_funs · f.name} À
Ü	{r : ran formal_funs· f.name}
°
¹ZAX
Ü	prefix : (ID ¸ ðID ¸ Package) ­ Package
°
=DOC
	val new_scope_with : ID -> unit;
=DESCRIBE
ÿnew_scope_withüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	IDENT;
Ü	PACK_ENV;
Ü	Block;
Ü	Package'
÷üüüüüüüü
Ü	z' =
Ü	z ë ë/ (map trans_basic_decl consts_types') ë
Ü	map (trans_informal_fun » z_ax) informal_funs'ë
Ü	map (trans_formal_fun » z_ax) formal_funs';
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = prefix(ident, new_ids(pack_env ident), pack_env ident);
Ü	pack_body_flag = pack_spec_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag =
Ü	speclabel_flag = till_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = §¢;
Ü	formal_procs = {};
Ü	formal_procs = {};
Ü	dec_labels = {}
ˆüüüüüüüüüüüüüüü
=FAILURE
507008	No package specification for package ?0 has been declared
=ENDDOC
\section{STUBS AND SUBUNITS}\label{STUBSANDSUBUNITS}
\subsection{The SID function begin\_stub}
=DOC
val Ûbegin_stubÝ : unit -> unit;
=DESCRIBE
ÿbegin_stubüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks, True)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function end\_stub}
=DOC
val Ûend_stubÝ : unit -> unit;
=DESCRIBE
ÿend_stubüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks, False)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_subunit}
=DOC
val Ûnew_scope_subunitÝ : ID -> unit;
=DESCRIBE
ÿend_stubüüüüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	subunit_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC

\section{WEB CLAUSES}\label{WEBCLAUSES}
\subsection{THE SID function z\_copy}
ÿZPARAüüüüüüüüüüü
Ü	zpara : Z_PARA
ˆüüüüüüüüüüüüüüü
ÿz_copyüüüüüüüüüüü
Ü	„Z_DOC;
Ü	Z_PARA
÷üüüüüüü
Ü	z' = z ë §zpara¢
ˆüüüüüüüüüüüüüüü
\subsection{THE SID function new\_scope\_dec\_replace}
=DOC
val Ûnew_scope_dec_replaceÝ : REPLACED_BY_DECL -> unit;
=DESCRIBE
ÿnew_scope_dec_replaceüüüüüüüüüüü
Ü	„ENV;
Ü	„DEC_ENV;
Ü	LAB;
Ü	Block
÷üüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	ÊDeclab = Declab_declabel_flag(dec_env label, True)
Ü	dec_lab = label;
Ü	dec_env' = {label} á dec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507002	?1 has not been introduced as a declaration label
=ENDDOC

\subsection{THE SID function update\_envs\_remove\_declabel}
=DOC
	val Ûupdate_subunit_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_subunit_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		s' = Subunit_vc_vars(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_dec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		d' = Declab_vc_vars(d, d.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_spec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Declab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		s' = Speclab_vc_vars(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
		update_envs_remove_declabel
	¦	update_subunit_env_remove_declabel
	±	update_dec_env_var
	±	update_spec_env_remove_declabel
°
=ENDDOC
\subsection{THE SID function new\_scope\_speclabel}
=DOC
	val Ûnew_scope_speclabelÝ: LABEL -> unit
=DESCRIBE
ÿnew_scope_speclabelüüüüüüüüüüüüüü
Ü	„ENV;
Ü	LAB;
Ü	SPEC_ENV;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	speclabel_flag = True;
Ü	till_flag = (spec_env label).till_flag;
Ü	pack_spec_flag = pack_body_flag = stub_flag =
Ü	subunit_flag = formal_body_flag = fun_flag = declabel_flag = False;
Ü	spec_lab = label;
Ü	till = (spec_env label).till
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?1 has not been introduced
=ENDDOC
\subsection{THE SID function vcs\_speclabel}
=DOC
	val Ûvcs_speclabelÝ: REFINED_BY -> unit
=DESCRIBE
ÿvcs_speclabelüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	SEQ_STMTS;
Ü	SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(spec_env spec_lab', st))¢
Ü	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü

=ENDDOC
=ENDDOC
\subsection{THE SID function end\_scope\_speclabel}
=DOC
	val Ûend_scope_speclabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿend_scope_speclabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	end_scope;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	spec_ebv' = {spec_lab'} á spec_env
Ü	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{THE SID functions new\_scope\_stmtlabel and end\_scope\_stmt\_label}
=DOC
	val Ûnew_scope_stmt_labelÝ: REPLACED_BY_DECL -> unit
	val Ûend_scope_stmt_labelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
	new_scope_stmt_label ¦ new_scope_speclabel
°
¹Z
	end_scope_stmt_label ¦ end_scope_speclabel
°
=ENDDOC

\subsection{Replacement Environment Manipulation}
To describe the manipulation of the replacement environment, which allows the SPARK program to be extracted, we use an additional SID function.
This is called at the following points in the syntax.

=GFT
web_clause =
	z,
	compilation <update_spark_prog>,
	comp_label replacedby compilation <update_replacement_env>,
	ppart_label replacedby private_part <update_replacement_env>,
	vpart_label replacedby visible_part <update_replacement_env>,
	dec_label replacedby dec dp1 <update_replacement_env>,
	stmt_label replacedby sequence_of_statements <update_replacement_env>,
	spec_label refinedby sequence_of_statements <update_replacement_env>,
	refinedby sequence_of_statements <update_replacement_env>,
	spec_label replacedby sequence_of_statements <update_replacement_env>,
	replacedby sequence_of_statements <update_replacement_env>;
=TEX
(The manipulation of the replacement environment does not interact with the other SID functions, and so the interleaving of calls to $update\_replacement\_env$ and the other SID functions is immaterial).

The global variable $REPL$ holds the right-hand side of one of the replacement or refinement web clauses:

ÿREPLüüüüüüüüüüüüüü
Ü	repl : REPLACEMENT
ˆüüüüüüüüüüüüüüüüü
The global variable $COMP$ holds the current compilation (or k-slot):

ÿCOMPüüüüüüüüüüüüüü
Ü	comp : K_Slot_Compilation_Unit
ˆüüüüüüüüüüüüüüüüü

$update\_replacement\_env$ adds the maplet mapping the current label (in the global variable $LAB$) to $REPL$ to the replacement environment.
=DOC
val Ûupdate_spark_progÝ : LABEL * REPLACEMENT -> unit
=DESCRIBE

ÿupdate_replacemeent_envüüüüüüüüüüüüüü
Ü	„REPL_ENV;
Ü	LAB;
Ü	REPL
÷üüüüüüüüüüüüüüü
Ü	repl_env' = repl_env « {label í repl}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûupdate_spark_progÝ : LABEL * REPLACEMENT -> unit
=DESCRIBE
$update\_spark\_prog$ appends the current compilation to the sequence of same held in the SPARK program environment.

ÿupdate_spark_progüüüüüüüüüüüüüü
Ü	„SPARK_Prog;
Ü	COMP
÷üüüüüüüüüüüüüüü
Ü	spark' = spark ë §comp¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?1 has not been introduced
507004	label ?1 has already been refined or replaced
507005	label ?1 has already been used
=ENDDOC
\section{INTERFACE}
=DOC
val Ûcn_z_generatorÝ : CNTypes.WEB_CLAUSE -> unit
=DESCRIBE
=ENDDOC
\section{EPILOGUE}
=SML
end; (* local...in *)
end; (* signature CNZGenerator *)
=TEX
\section{TEST POLICY}
The functions in this document are to be tested according to the
criteria identified in \cite{ISS/HAT/DAZ/PLN003}.

\small
\twocolumn[\section{INDEX}]
\printindex

\end{document}



