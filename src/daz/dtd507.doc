%  %Z% $Revision$ $RCSfile$ $Date$
=TEX
% TQtemplate.tex
\documentstyle[hol1,11pt,TQ]{article}
\ftlinepenalty=9999
\def\Hide#1{}
\def\Bool{``$\it{:}bool\,$''}
\makeindex
\TPPproject{DAZ PROJECT}  %% Mandatory field
%\TPPvolume{}
%\TPPpart{}
\TPPtitle{Detailed Design: Z Generator}  %% Mandatory field
\TPPref{ISS/HAT/DAZ/DTD507}  %% Mandatory field
\def\SCCSversion{$Revision$%
}
\TPPissue{\SCCSversion}  %% Mandatory field
\TPPdate{\FormatDate{$Date$%
}}
%\TPPstatus{Approved}
\TPPstatus{Draft}
\TPPtype{Specification}
%\TPPkeywords{SPARK}
\TPPauthor{R.D.~Arthan&WIN01}
\TPPauthorisation{D.J.~King & DAZ Team Leader}
\TPPabstract{
This document contains the detailed design for the
Compliance Notation Z Generation.}
%\TPPabstractB{}
%\TPPabstractC{}
%\TPPabstractD{}
%\TPPabstractE{}
%\TPPabstractF{}
\TPPdistribution{\parbox[t]{4.0in}{%
	A.~Smith, DRA \\
	Library}}

%\TPPclass{CLASSIFICATION}
%\def\TPPheadlhs{}
%\def\TPPheadcentre{}
%def\TPPheadrhs{}
%\def\TPPfootlhs{}
%\def\TPPfootcentre{}
%\def\TPPfootrhs{}

\begin{document}
\TPPsetsizes
\makeTPPfrontpage

\vfill
\begin{centering}

\bf Copyright \copyright\ : International Computers Ltd \number\year

\end{centering}

\newpage
\section{DOCUMENT CONTROL}
\subsection{Contents List}
\tableofcontents
\subsection{Document Cross References}
\bibliographystyle{fmu}
\bibliography{fmu,hatdocs,daz}

\subsection{Changes History}  % to get section number `0.3'
\begin{description}
\item[Issue 1.1-1.21] Initial drafts.
\item[Issue 1.22 (21th September 1994) ] Rework done according to deck-check report reference 0010 and checked by KB.
\item[Issues 1.22-1.34] Phase 3 rework.
\item[Issues 1.35-1.43] Fixed to the Z during type-checking.
\item[Issue 1.44] Final version for issue.
\item[Issue 1.45-1.47] Bug fixes.
\item[Issue 1.48] Enhancements 1, 5, 6, 7 and 20; bug fix 17 (batch 2).
\item[Issue 1.49] Enhancement 10.
\item[Issue 1.50] Issue for review.
\item[Issue 1.51] Exposed $add\_type\_info$.
\item[Issue 1.52 (14th December 1995)] Changes according to desk check report 024.
\item[Issue 1.53] Fixed bug 6 (V0.6).
\item[Issue 1.54] New error message for resolution of issue 1 (V0.6).
\item[Issue 1.55] Updated reference to DRA spec.
\item[Issue 1.56] Added $new\_script1$ for IUCT project WP 1.
\item[Issue 1.57 - 1.58] Changes for IUCT WP 7.
\item[Issue 1.59-1.60] Changes for IUCT WP 2.
\item[Issue 1.61] Further changes for IUCT WP 7.
\item[Issue 1.62-1.64] Additional error messages.
\end{description}
\subsection{Changes Forecast}
None.
\section{GENERAL}
\subsection{Scope}
This document contains the detailed design for the functions whose Z specification is given in in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}; it is called for in \cite{ISS/HAT/DAZ/HLD503}.
Sections \ref{BASICDECLARATIONS}-\ref{WEBCLAUSES} contain the design and correspond directly with sections 4-16 of the DRA specification.

\subsection{Introduction}
This document gives the structure (i.e., module) containing the functions defined \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}.
This covers the main semantic processing involved in the extraction of a Z document from a Compliance Notation script.
As usual it also includes a transcription into {\ProductZ} of the relevant parts of the DRA specification.

The overall effect of the processing defined here is to update the {\Product} theory database as if the Z document had been loaded into it and to update internal state representing the environments of  \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1} as implemented in \cite{ISS/HAT/DAZ/DTD513}.
The internal state also includes additional information defined in \cite{ISS/HAT/DAZ/DTD513} and used to record the association of k-slot labels with SPARK program fragments.
This gives all the information required to reduce extraction of the Z document and of the SPARK program to straightforward pretty-printing tasks.



\subsubsection{Purpose and Background}
See \cite{ISS/HAT/DAZ/HLD503}.


\subsubsection{Dependencies}
See \cite{ISS/HAT/DAZ/HLD503}.
%\subsubsection{Possible Enhancements}
\subsubsection{Deficiencies}
The Z in this document has been type-checked with the exception of a small number of paragraphs which define the following: $form\_fun\_subunit$, $form\_fun$ and $stub\_spec\_fun$. These Z objects have been syntax-checked but a full type-checking of them with the current version of {\ProductZ} takes an enormous amount of processing due to the width of the schemas involved.


\subsection{Compliance}
For the description of the Z in this document see \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}. Where the Z differs from that in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}, justification has been provided.

In \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1} where names contain double underscores, the implementation has chosen to use only single underscores (no ambiguity results from this).

In {\ProductZ}, subscripts are not decoration. In order to achieve the effect required by \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}, multiple priming has been used and generally, the number of primes in a decoration corresponds to the numeric value of the subcript in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1}.

In a number of places, the Z in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/2.1} (and hence in this document) is recognised to be deficient. In specific cases, agreed with DRA, the implementation has been dicussed and agreed, but the Z has not been brought into line with the implementation. Where this is the case, there is a note to draw attention to this fact.







\section{PREAMBLE}
\subsection{Preamble for Z Type-Checking}

The following initialises the theory database when performing a syntax and type check on the Z paragraphs in this document. (This preamble is not processed when building the compliance tool.)

=SMLZ
open_theory"dtd505";
push_pc "z_library";
force_delete_theory"dtd507" handle Fail _ => ();
val _ = set_flag ("z_type_check_only", false);
new_theory "dtd507";
=TEX

\subsection{The Signature}
=DOC
signature ÛCNZGeneratorÝ = sig
=DESCRIBE
=ENDDOC

=SML
local
open	CNTypes CNTypes1 CNTypes2 ZParagraphs ZUserInterfaceSupport;
in
=TEX
\section{BASIC DECLARATIONS}\label{BASICDECLARATIONS}
\subsection{The SID Function basic\_declaration}
ÿBASIC_DECüüüüüüüüüüüüüüüüüüüüü
Ü	basic_decl : BASIC_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûbasic_decl_pack_specÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	„Z_DOC;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_consts_types(ÊPackage, consts_types ë §basic_decl¢)};
Ü	z' =
Ü	z ë trans_basic_decl basic_decl
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_decl_otherwiseÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_otherwiseüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	z' =
Ü	z ë trans_basic_decl basic_decl
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507041	Unsupported language feature encountered in a basic declaration
=ENDDOC
=DOC
val Ûbasic_declarationÝ : BASIC_DECL -> unit;
=DESCRIBE
¹Z
Ü	basic_declaration ¦ basic_decl_pack_spec ² basic_decl_otherwise
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function var\_pack\_spec}
ÿVAR_DECLüüüüüüüüüüüüüüüüüüüüü
Ü	vars : ð Var_Decl
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûvar_pack_specÝ : VAR_DECL -> unit;
=DESCRIBE
In the implementation, variable declarations contain lists of identifiers, rather than single identifiers (i.e., they are as in the concrete syntax rather than the Z abstract syntax).
We therefore only deal with a single $VAR\_DECL$ here.
ÿvar_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	VAR_DECL;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_vc_vars(ÊPackage, vc_vars À vars) }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function update\_envs\_var}
=DOC
val Ûupdate_subunit_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_subunit_env_varüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Subunit_vc_vars(s, s.vc_vars À vars) ²
Ü		dec_lab' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_dec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_dec_env_varüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		dec_lab'  d.dec_labels ±
Ü		d' = Declab_vc_vars(d, d.vc_vars À vars) ²
Ü		dec_lab' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_spec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_spec_env_varüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Speclab_w
Ü		(Speclab_vc_vars(s, s.vc_vars À vars),
Ü		s.w À {v : vars· trans_id v.var}) ²
Ü		dec_lab' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_envs_varÝ : VAR_DECL -> unit;
=DESCRIBE
¹Z
Ü		update_envs_var
Ü	¦	update_subunit_env_var
Ü	±	update_dec_env_var
Ü	±	update_spec_env_var
°
=FAILURE
507001	Internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function add\_var\_env}
=DOC
val Ûadd_var_envÝ : VAR_DECL -> unit;
=DESCRIBE
ÿadd_var_envüüüüüüüüüüüüüü
Ü	„ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' = blocks « {1 í Block_vc_vars(blocks 1, vc_vars' À vars)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID Function add\_var\_init\_env}
=DOC
val Ûadd_var_init_envÝ : (VAR_DECL * EXP) -> unit;
=DESCRIBE
ÿadd_var_init_envüüüüüüüüüüüüüü
Ü „ENV
Ü VAR_DECL
Ü Block‰1
÷üüüüüü
Ü ÊBlock‰1 = blocks 1
Ü init = no_init ±
Ü blocks' = blocks ²
Ü (¶e: EXP· init=init_val e ±
Ü   blocks' = blocks « {1 í 
Ü              Block__var_inits(blocks 1, var_inits‰1 À {v: vars·v.var í e})})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507043	Attempting to give variable initialisation for ?0 when it is already initialised
=ENDDOC
\section{DECLARATIONS}\label{DECLARATIONS}
\subsection{The SID function k\_slot\_dec}
ÿLABüüüüüüüüüüüü
Ü	label : LABEL
ˆüüüüüüüüüüüüüü
¹ZAX
Ü	no_label : LABEL
°
¹Z
fun 6 _dot_
°
¹ZAX
Ü	_dot_: (ID ¸ ID) ­ ID
°
=DOC
val Ûk_slot_decÝ : LABEL -> unit;
=DESCRIBE
ÿk_slot_decüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	„ENV;
Ü	LAB;
Ü	ENV;
Ü	Declab;
Ü	Block';
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	dec_env' = dec_env À {label í ÊDeclab};
Ü	subunit_flag'' = True ± block_name = block_name'' dot block_name' ²
Ü	subunit_flag'' = False ± block_name = block_name';
Ü	ÊFlags = ÊFlags';
Ü	ÊIn_Scope = flatten_env(ÊENV);
Ü	blocks' =
Ü	blocks « {1 í Block_dec_labels (blocks 1, dec_labels' À {label})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, $ENV$ should be $„ENV$ and the $blocks'$ component is also updated. (See Implementation.) 
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
507010	?0 is already in use as a declaration label
=ENDDOC

\section{STATEMENTS}\label{STATEMENTS}
\subsection{The SID function spec\_stmt}
ÿSPEC_STMTüüüüüüüüüüüü
Ü	specification : Spec
ˆüüüüüüüüüüüüüü
=DOC
val Ûspec_stmt_speclabelÝ : {spec :SPEC, label : LABEL} -> unit;
=DESCRIBE
ÿspec_stmt_speclabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	SPEC_STMT;
Ü	LAB;
Ü	ENV;
Ü	Speclab;
Ü	Speclab'';
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = spec_env À {label í ÊSpeclab};
Ü	ÊSpeclab'' = spec_env spec_lab';
Ü	ÊSpec = specification;
Ü	formal_body_flag = formal_body_flag'';
Ü	fun_flag = fun_flag'';
Ü	till_flag = till_flag';
Ü	fun_header = fun_header'';
Ü	return = return'';
Ü	till = till';
Ü	vc_vars = vc_vars'';
Ü	vc_pars = vc_pars'' À (flatten_env(ÊENV)).vc_pars;
Ü	vc_log_cons = vc_log_cons'' À vc_log_cons';
Ü	vc_aux_vars = vc_aux_vars'';
Ü	formal_procs = formal_procs'';
Ü	dec_labels = dec_labels''
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507014	specification label ?0 has not been introduced
507015	label ?0 has already been introduced
507033	badly formed logical constant encountered
=ENDDOC
=DOC
val Ûspec_stmt_otherwiseÝ : {spec : SPEC, label : LABEL} -> unit;
=DESCRIBE
ÿspec_stmt_otherwiseüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	SPEC_STMT;
Ü	LAB;
Ü	ENV;
Ü	Speclab;
Ü	Formal_Fun';
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	speclabel_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = spec_env À {label í ÊSpeclab};
Ü	ÊSpec = specification;
Ü	formal_body_flag = formal_body_flag';
Ü	fun_flag = fun_flag';
Ü	till_flag = till_flag';
Ü	current_formal_fun' = ÊFormal_Fun';
Ü	fun_header = ÊInformal_Fun';
Ü	return =post';
Ü	till = till';
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
¹Z
Ü	spec_stmt ¦ spec_stmt_speclabel ² spec_stmt_otherwise
°
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function k\_slot\_stmt}
=DOC
val Ûk_slot_stmtÝ : LABEL -> unit;
=DESCRIBE
¹Z
Ü	k_slot_stmt ¦ spec_stmt
°
=FAILURE
507015	label ?0 has already been introduced
=ENDDOC
\subsection{The SID function add\_log\_con\_env}
ÿLOGICAL_CONüüüüüüüüü
Ü	logical_con : Z_Decl
ˆüüüüüüüüüüüüüüüü
=DOC
val Ûadd_log_con_envÝ : LOG_CON -> unit;
=DESCRIBE
ÿadd_log_con_envüüüüüüüüüüü
Ü	„ENV;
Ü	LOGICAL_CON
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, {logical_con})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=FAILURE
507032	Declaration of ?0 has already been introduced 
=ENDDOC
=DOC
val Ûremove_log_con_envÝ : unit -> unit;
=DESCRIBE
ÿremove_log_con_envüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_log_cons(blocks 1, {})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{LOOPS}\label{LOOPS}
\subsection{The SID function new\_scope\_loop}
=DOC
	val Ûnew_scope_loopÝ : unit -> unit;
=DESCRIBE
ÿnew_scope_loopüüüüüüüü
Ü	„ENV;
Ü	Empty_Block;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊBlock' = blocks 1;
Ü	pack_spec_flag = stub_flag = subunit_flag =
Ü		declabel_flag = till_flag = False;
Ü	formal_body_flag = formal_body_flag';
Ü	fun_flag = fun_flag';
Ü	speclabel_flag = speclabel_flag';
Ü	current_formal_proc = current_formal_proc';
Ü	current_formal_fun = current_formal_fun';
Ü	spec_lab = spec_lab'
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\subsection{The SID function end\_scope}

=DOC
val Ûend_scopeÝ : unit -> unit;
=DESCRIBE
ÿend_scopeüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = tail blocks
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507006	Internal error: running environment stack unexpectedly empty
=ENDDOC
\subsection{The SID function for\_param}
ÿFOR_PARAMüüüüüüüüüüü
Ü	Param_Spec
÷üüüüüüü
Ü	mode = inn
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûfor_paramÝ : ID * TMARK -> unit;
=DESCRIBE
ÿfor_paramüüüüüüüüüüüüü
Ü	„ENV;
Ü	FOR_PARAM
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, {ÊParam_Spec})}
ˆüüüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=ENDDOC
\subsection{The SID function till\_pred}
ÿTILL_PREDüüüüüüüüüüü
Ü	till : Z_PRED
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûtill_predÝ : Z_TM -> unit;
=DESCRIBE
ÿtill_predüüüüüüüüüüüüü
Ü	„ENV;
Ü	TILL_PRED
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_till(Block_till_flag(blocks 1, True), till)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC

\section{SUBPROGRAM DECLARATIONS}\label{SUBPROGRAMDECLARATIONS}
The SID function $end\_scope$ used in processing these has already been defined in section \ref{LOOPS}.
\section{PROCEDURES}\label{PROCEDURES}
\subsection{The SID function subunit\_form}
ÿIDENTüüüüüüüüüüüüüüüüüüüüü
Ü	ident : ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûsubunit_formÝ : ID -> unit;
=DESCRIBE
ÿsubunit_formüüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_PARENTS;
Ü	SUBUNIT_ENV;
Ü	IDENT;
Ü	„Block;
Ü	Subunit''
÷üüüüüüüüüüüüüüü
Ü	subunit_flag = True;
Ü	ÊBlock = head blocks;
Ü	blocks' = blocks « {1 í ÊBlock'};
Ü	parents = {zmod''.mod_name};
Ü	z' = z ë §z_parents(ÊZ_PARENTS)¢;
Ü	ÊSubunit'' = subunit_env(block_name, ident);
Ü	block_name' = block_name;
Ü	ÊFlags' = ÊFlags;
Ü	ÊIn_Scope' = ÊIn_Scope''
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function subunit\_inf}
=DOC
	val Ûsubunit_infÝ : ID -> unit;
=DESCRIBE
ÿsubunit_infüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	subunit_form
÷üüüüüüüüüüüüüüü
Ü	subunit_env' = {(block_name, ident)} á subunit_env
ˆüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function new\_scope\_proc\_inf}
=DOC
	val Ûnew_scope_proc_infÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_proc_infüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag = speclabel_flag =
Ü	till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_proc\_form}
=DOC
	val Ûnew_scope_proc_formÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_proc_formüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	formal_body_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub}
¹ZAX
Ü	trans_subunit_name : ID ¸ ID ­ Z_ID
Ü	make_module : Z_ID ¸ seq Z_PARA ­ seq Z_PARA
°
=DOC
val Ûtrans_subunit_nameÝ : ID * ID -> Z_ID;
val Ûmake_moduleÝ : Z_ID -> unit;
val ÛstubÝ : unit -> unit;
=DESCRIBE
ÿstubüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	„Z_DOC;
Ü	ENV;
Ü	Subunit;
Ü	id1, id2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü 	¶mod_name : Z_ID·
Ü		mod_name = trans_subunit_name(id1, id2) ±
Ü		z' = make_module(mod_name, z) ë z ±
Ü 		zmod = ÊZ_MODULE;
Ü	subunit_env' = subunit_env  À {(id1, id2) í ÊSubunit};
Ü		subunit_flag''' = True ± id1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id1 = block_name'';
Ü	id2 = block_name';
Ü	specif_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507013	A stub called ?0 has already been introduced
=ENDDOC
\subsection{The SID function stub\_spec\_proc}
ÿFORM_PROCüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Proc
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_procÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿstub_spec_procüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_PROC;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	ÊIn_Scope' = ÊIn_Scope
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function form\_proc}
=DOC
val Ûform_proc_pack_specÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿform_proc_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_procs(ÊPackage, formal_procs À {ÊFormal_Proc})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_pack_body_commonÝ : FORMAL_PROC ->
			(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) OPT
=DESCRIBE
ÿ form_proc_pack_body_commonüüüüüüüüüü
Ü	„Z_DOC;
Ü	PACK_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	Formal_Proc''';
Ü	Block';
Ü	Block'';
Ü	st : Statement;
Ü	free : ð Z_ID;
Ü	pack_body_vars : ð Var_Decl
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊPackage'''' = pack_env block_name'';
Ü	block_name'  {p : formal_procs'''' · p.name};
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab''''', st))¢;
Ü	ÊFormal_Proc'''  formal_procs''''; name''' = block_name';
Ü	fun_flag''''' = False;
Ü	vc_pars''''' = vc_pars'; vc_log_cons''''' = {};
Ü	vc_aux_vars''''' = {};
Ü	free = free_vars_zpred Pre''' À free_vars_zpred post''';
Ü	pack_body_vars = vc_vars'' \ vc_vars'''';
Ü	(		(st = stmt(spec_no_ivars(ÊSpec)))
Ü		²	(st = spec_ivars(ÊSpec, null))
Ü	)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
507051	Free variables are not allowed in VCs.
	The VC ?0 contains the free variable ?1.
507052	Free variables are not allowed in VCs.
	The VC ?0 contains the free variables ?1.
=ENDDOC
=DOC
val Ûform_proc_pack_bodyÝ :
	(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) ->FORMAL_PROC -> 
		unit;
=DESCRIBE
ÿ form_proc_pack_bodyüüüüüüüüüüüüüü
Ü	form_proc_pack_body_common
÷üüüüüüüüüüüüüüü
Ü	(w''' À free) ¡ {a : aux_vars'''' · a.zvar} = š;
Ü	w''''' = w''' À {v : pack_body_vars · trans_id v.var};
Ü	Pre''''' = Pre''';
Ü	post''''' = post''';
Ü	vc_vars''''' = vc_vars''
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_pack_body_auxÝ :
	(BLOCK * FORMAL_PROC * PACKAGE * SPECLAB) ->
	TERM list -> FORMAL_PROC -> unit;
=DESCRIBE
ÿ  form_proc_pack_body_auxüüüüüüüüüüüüüü
Ü	form_proc_pack_body_common;
Ü	„ENV;
Ü	aux_vars, aux_vars0 : ð Z_Decl;
Ü	conc_vars : ð Var_Decl;
Ü	invs : ð Z_PRED;
Ü	Spec'''''';
Ü	frame_aux_conc, frame_aux_conc0, add_aux, add_aux0 : ð Z_ID;
Ü	seq_aux : seq Z_Decl
÷üüüüüüüüüüüüüüü
Ü	(w''' À free) ¡ {a : aux_vars'''' · a.zvar} = š;
Ü	add_aux = free ¡ {a : aux_vars'''' · a.zvar} \ w''';
Ü	w'''''' = w''' À add_aux;
Ü	Pre'''''' = Pre''';
Ü	post'''''' =
Ü	z_many_and ({post'''} À
Ü	  {a : add_aux · z_eq(zid a, subs_exp(zid a, add_aux, add_aux0))});
Ü	aux_vars = {a : aux_vars'''' | a.zvar  w''''''};
Ü	conc_vars = Þ {x : using_decs'' ¨ w''''''© · first x};
Ü	invs = {x : using_decs'' ¨ w''''''© · second x};
Ü	frame_aux_conc = w'''''' À {c : conc_vars · trans_id c.var};
Ü	# seq_aux = # aux_vars;
Ü	ran seq_aux = aux_vars0;
Ü	w''''' = frame_aux_conc À {v : pack_body_vars · trans_id v.var} \
Ü	  {a : aux_vars · a.zvar};
Ü	Pre''''' = z_exists (aux_vars, z_many_and ({Pre''''''} À invs));
Ü	post''''' =
Ü	 z_forall (seq_aux, z_imp (subs_pred (z_many_and
Ü	  ({Pre''''''} À invs), frame_aux_conc, frame_aux_conc0),
Ü	  z_exists (aux_vars, z_many_and ({post''''''} À invs))));
Ü	vc_vars''''' = vc_vars'' À conc_vars;
Ü	blocks' = blocks « {1 í Block_vc_vars(blocks 1, vc_vars' À conc_vars)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_proc_subunitÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿ  form_proc_subunitüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	„SUBUNIT_ENV;
Ü	FORM_PROC;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name')} á subunit_env;
Ü	specif_flag''' = True;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab'''', st))¢;
Ü	ÊSpec'''' = specif''';
Ü	fun_flag'''' = False;
Ü	vc_vars'''' = vc_vars''';
Ü	vc_pars'''' = vc_pars';
Ü	vc_log_cons'''' = {}
Ü	vc_aux_vars'''' = vc_aux_vars''';
Ü	(	(st = stmt(spec_no_ivars(ÊSpec)))
Ü	  ² 	(st = spec_ivars(ÊSpec, null))
Ü	)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_procÝ : FORMAL_PROC -> unit;
=DESCRIBE
¹Z
Ü	form_proc ¦ 	form_proc_pack_spec ² form_proc_pack_body ²
Ü			form_proc_pack_body_aux ² form_proc_subunit 
°
=ENDDOC
\subsection{The SID function curr\_form\_proc}
=DOC
	val Ûcurr_form_procÝ : FORMAL_PROC -> unit;
=DESCRIBE
ÿcurr_form_procüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORM_PROC
÷üüüüüüüüüüüüüüü
Ü	blocks' =
Ü	blocks « {1 í Block_current_formal_proc(blocks 1, ÊFormal_Proc)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{FUNCTIONS}\label{FUNCTIONS}
\subsection{The SID function new\_scope\_fun\_inf}
=DOC
	val Ûnew_scope_fun_infÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_fun_infüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	fun_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = declabel_flag = speclabel_flag =
Ü	till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_fun\_form}
=DOC
	val Ûnew_scope_fun_formÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_fun_formüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	formal_body_flag = fun_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = subunit_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function stub\_spec\_fun}
ÿFORM_FUNüüüüüüüüüüüüüüüüüüüüü
Ü	Formal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûstub_spec_funÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿ  stub_spec_funüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	FORM_FUN;
Ü	„Subunit;
Ü	id‰1, id‰2 : ID;
Ü	Block';
Ü	Block'';
Ü	Block'''
÷üüüüüüüüüüüüüüü
Ü	stub_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	ÊBlock''' = blocks 3;
Ü	subunit_env(id‰1, id‰2) = ÊSubunit;
Ü	subunit_env' = subunit_env « {(id‰1, id‰2) í ÊSubunit'};
Ü		subunit_flag''' = True ± id‰1 = block_name''' dot block_name''
Ü	²	subunit_flag''' = False ± id‰1 = block_name'';
Ü	id‰2 = block_name';
Ü	specif_flag' = True;
Ü	specif' = ÊSpec;
Ü	zmod' = zmod;
Ü	ÊIn_Scope' = ÊIn_Scope
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507011	A subunit ?0 containing ?1 has not been introduced 
=ENDDOC
\subsection{The SID function inf\_fun}
ÿINF_FUNüüüüüüüüüüüüüüüüüüüüü
Ü	Informal_Fun
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
	val Ûcart_prod1Ý : PARAM_SPEC list -> Z_EXP;
=DESCRIBE
¹ZAX
Ü	cart_prod : seq‰1 Param_Spec ß Z_EXP
°
The implementation of this function will be included as part of the VC generator as a) it is required there and b) this module depends on the VC generator. The name is included in this signature for traceability purposes.
=ENDDOC
=DOC
	val Ûfun_decl1Ý : INFORMAL_FUN -> Z_DECL;
=DESCRIBE
¹ZAX
Ü	fun_decl : Informal_Fun ­ Z_Decl
÷üüüüüüüüüüüüü
Ü	µ Informal_Fun; Z_Decl·
Ü	fun_decl (Ê Informal_Fun) = ÊZ_Decl ¤
Ü		formal_pars = §¢ ± zvar = trans_id name ±
Ü		zexp = zid(trans_id return_type) ²
Ü		formal_pars ½ §¢ ± zvar = trans_id name ±
Ü		zexp = z_tfun(cart_prod formal_pars, zid(trans_id return_type))
°
The implementation of this function will be included as part of the VC generator as a) it is required there and b) this module depends on the VC generator. The name is included in this signature for traceability purposes.
=ENDDOC
=DOC
val Ûinf_fun_pack_specÝ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿinf_fun_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	INF_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_informal_funs(ÊPackage, informal_funs ë §ÊInformal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûtrans_informal_funÝ : INFORMAL_FUN -> PARAINFO;
=DESCRIBE
¹ZAX
Ü	trans_informal_fun : Informal_Fun ­ Z_Ax
÷üüüüüüüüüüüüü
Ü	µf: Informal_Fun; Z_Ax·
Ü	trans_informal_fun f = ÊZ_Ax ¤ decls = {fun_decl f} ± preds = {}
°
=ENDDOC
=DOC
val Ûinf_fun_otherwiseÝ : INFORMAL_FUN -> unit;
=DESCRIBE
ÿinf_fun_otherwiseüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	INF_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_informal_fun(ÊInformal_Fun))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûinf_funÝ : INFORMAL_FUN -> unit;
=DESCRIBE
¹Z
Ü	inf_fun ¦ inf_fun_pack_spec ² inf_fun_otherwise
°
=ENDDOC
\subsection{The SID function form\_fun}
=DOC
val Ûform_fun_pack_specÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = True;
Ü	ÊBlock'' = blocks 2;
Ü	pack_env block_name'' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{block_name'' í
Ü		Package_formal_funs(ÊPackage, formal_funs ë §ÊFormal_Fun¢)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûz_declsÝ : PARAM_SPEC list -> Z_DECL list;
=DESCRIBE
¹ZAX
Ü	z_decls : seq‰1 Param_Spec ß seq‰1 Z_Decl[Z_EXP]
°
=ENDDOC
=DOC
val Ûtrans_formal_funÝ : FORMAL_FUN -> PARAINFO;
=DESCRIBE
¹ZAX
Ü	trans_formal_fun : Formal_Fun ß Z_Ax
÷üüüüüüüüüüüüü
Ü	µFormal_Fun; Z_Ax·
Ü	trans_formal_fun (ÊFormal_Fun) = ÊZ_Ax ¤
Ü		decls = {fun_decl (ÊInformal_Fun)} ±
Ü			(formal_pars = §¢ ± preds = {z_imp(Pre, post)} ²
Ü			formal_pars ½ §¢ ±
Ü			preds = {z_forall(z_decls formal_pars, z_imp(Pre, post))})
°
=ENDDOC
=DOC
val Ûform_fun_pack_bodyÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_pack_bodyüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	PACK_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Package'''';
Ü	Speclab''''';
Ü	ref : seq Z_PARA;
Ü	Formal_Fun''';
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	pack_body_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_formal_fun(ÊFormal_Fun))¢ ë ref;
Ü	ÊPackage'''' = pack_env block_name'';
Ü	(
Ü		block_name'  {f : ran formal_funs'''' · f.name}
Ü	±	ref = §z_vcs(vcs(ÊSpeclab''''', st))¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊFormal_Fun'''  ran formal_funs'''' ± name''' = block_name'
Ü	±	ÊSpec''''' = ÊSpec''' ± formal_body_flag''''' = True
Ü	±	fun_flag''''' = True
Ü	±	fun_header''''' = ÊInformal_Fun ± vc_vars''''' = {}
Ü	±	vc_pars''''' = vc_pars' ± vc_log_cons''''' = {}
Ü	±	vc_aux_vars''''' = {}
Ü	)
Ü	²
Ü		(block_name' Ž {f : ran formal_funs'''' · f.name} ± ref = §¢)
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_subunitÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿ form_fun_subunitüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	„SUBUNIT_ENV;
Ü	FORM_FUN;
Ü	ENV;
Ü	Subunit''';
Ü	Speclab'''';
Ü	ref : seq Z_PARA;
Ü	Block';
Ü	Block'';
Ü	st : Statement
÷üüüüüüüüüüüüüüü
Ü	subunit_flag'' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_formal_fun(ÊFormal_Fun))¢ ë ref;
Ü	ÊSubunit''' = subunit_env (block_name'', block_name');
Ü	subunit_env' = {(block_name'', block_name')} á subunit_env;
Ü		specif_flag''' = True
Ü	±	ref = §z_vcs(vcs(ÊSpeclab'''', st))¢
Ü	±	(st = stmt(spec_no_ivars(ÊSpec)) ² st = spec_ivars(ÊSpec, null))
Ü	±	ÊSpec'''' = specif''' ± formal_body_flag'''' = True
Ü	±	fun_flag'''' = True
Ü	±	fun_header'''' = ÊInformal_Fun ± vc_vars'''' = {}
Ü	±	vc_pars'''' = vc_pars' ± vc_log_cons'''' = {}
Ü	²
Ü		specif_flag''' = False ± ref = §¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507012	Internal error: entry for ?0 missing from package environment
=ENDDOC
=DOC
val Ûform_fun_otherwiseÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿform_fun_otherwiseüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	FORM_FUN;
Ü	ENV;
Ü	Block''
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag'' = pack_body_flag'' = subunit_flag'' = False;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_ax(trans_formal_fun(ÊFormal_Fun))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûform_funÝ : FORMAL_FUN -> unit;
=DESCRIBE
¹Z
Ü	form_fun ¦ 	form_fun_pack_spec ² form_fun_pack_body ²
Ü			form_fun_subunit ² form_fun_otherwise
°
=ENDDOC
\subsection{The SID function curr\_form\_fun}
=DOC
	val Ûcurr_form_funÝ : FORMAL_FUN -> unit;
=DESCRIBE
ÿcurr_form_funüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORM_FUN
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_current_formal_fun(blocks 1, ÊFormal_Fun)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{FORMAL PARAMETERS}\label{FORMALPARAMETERS}
ÿFORMALSüüüüüüüüüüüüü
Ü	formals : ð Param_Spec
ˆüüüüüüüüüüüüüüüüü
\subsection{The SID function formal\_part}
=DOC
	val Ûfformal_partÝ : PARAMETER_SPECIFICATION list -> unit;
=DESCRIBE
ÿformal_partüüüüüüüüüüüüü
Ü	„ENV;
Ü	FORMALS
÷üüüüüüüüüüüüüüü
Ü	blocks' = blocks « {1 í Block_vc_pars(blocks 1, formals)}
ˆüüüüüüüüüüüüüüüüü
=ENDDOC
\section{SUBPROGRAM BODIES}\label{SUBPROGRAMBODIES}
\subsection{The SID function update\_envs\_proc}
=DOC
	val Ûupdate_subunit_env_procÝ : unit -> unit;
=DESCRIBE
ÿupdate_subunit_env_procüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s'
Ü	·	dec_lab''  s.dec_labels ±
Ü		s' =
Ü		Subunit_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_procÝ : unit -> unit;
=DESCRIBE
ÿupdate_dec_env_procüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'
Ü	·	dec_lab''  d.dec_labels ±
Ü		d' =
Ü		Declab_formal_procs(d, d.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_procÝ : unit -> unit;
=DESCRIBE
ÿupdate_spec_env_procüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	declabel_flag'' = formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'
Ü	·	dec_lab''  s.dec_labels ±
Ü		s' =
Ü		Speclab_formal_procs(s, s.formal_procs À {current_formal_proc'})
Ü	²	dec_lab'' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_procÝ : unit -> unit;
=DESCRIBE
¹Z
Ü update_envs_proc ¦ update_subunit_env_proc ± update_dec_env_proc
Ü			± update_spec_env_proc
°
=ENDDOC
\subsection{The SID function add\_proc\_env}
=DOC
	val Ûadd_proc_envÝ : unit -> unit;
=DESCRIBE
ÿadd_proc_envüüüüüüü
Ü	„ENV;
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	blocks' =
Ü	blocks « {2 í Block_formal_procs(ÊBlock'',
Ü			formal_procs'' À {current_formal_proc'})}
ˆüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function vcs\_body}
ÿSEQ_STMTSüüüü
Ü	st : Statement
ˆüüüüüüüüüüü
=DOC
	val Ûvcs_body_procÝ : STATEMENT -> unit;
=DESCRIBE
ÿ vcs_body_procüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Proc';
Ü	Block';
Ü	Block''
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	ÊBlock'' = blocks 2;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_proc' = ÊFormal_Proc';
Ü 	pre = z_many_and({pre‰1} À
Ü        {v : dom var_inits‰1·z_eq(trans_id v, trans_exp(var_inits‰1 v))});
Ü	post = post';
Ü	fun_flag = False;
Ü	ÊIn_Scope = flatten_env(ÊENV);
Ü	(	pack_body_flag'' = True
Ü	±	w = w' À
Ü		  ({v : vc_vars' · trans_id v.var} \
Ü		 Þ {x : ran using_decs'' · {y : first x · trans_id y.var}})
Ü	)
Ü		²
Ü	(	pack_body_flag'' = False
Ü	±	w = w' À {v : vc_vars' · trans_id (v.var)}
Ü	)
ˆüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=ENDDOC
=DOC
	val Ûvcs_body_funÝ : STATEMENT -> unit;
=DESCRIBE
ÿvcs_body_funüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	Speclab;
Ü	Formal_Fun';
Ü	Block'
÷üüüüüüüü
Ü	formal_body_flag' = True;
Ü	fun_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(ÊSpeclab, st))¢;
Ü	current_formal_fun' = ÊFormal_Fun';
Ü	w = {v : vc_vars' · trans_id (v.var)};
Ü 	pre = z_many_and({pre‰1} À
Ü        {v : dom var_inits‰1·z_eq(trans_id v, trans_exp(var_inits‰1 v))});
Ü	post = post';
Ü	formal_body_flag = fun_flag = True;
Ü	fun_header= ÊInformal_Fun';
Ü	return = post';
Ü	ÊIn_Scope = flatten_env(ÊENV)
ˆüüüüüüüüüüüüüüü
Note: As agreed with DRA, this specification is insufficient. See implementation.
=ENDDOC
=DOC
	val Ûvcs_bodyÝ : STATEMENT -> unit;
=DESCRIBE
¹Z
Ü	vc_body ¦ vcs_body_proc ² vcs_body_fun
°
=ENDDOC
\section{PACKAGES}\label{PACKAGES}
\subsection{The SID function new\_scope\_pack\_spec}
=DOC
	val Ûempty_packageÝ : unit -> PACKAGE;
=DESCRIBE
ÿEmpty_Packageüüüüüüü
Ü	Package
÷üüüüüüüü
Ü	vc_vars = {};
Ü	consts_types = §¢;
Ü	formal_procs = {};
Ü	informal_funs = §¢;
Ü	formal_funs = §¢;
Ü	aux_vars = {}
ˆüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûnew_scope_pack_specÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_pack_specüüüüüüü
Ü	„ENV;
Ü	„PACK_ENV;
Ü	IDENT;
Ü	Empty_Block;
Ü	Empty_Package
÷üüüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	pack_spec_flag = True;
Ü	pack_body_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False;
Ü	pack_env' = pack_env À {ident í ÊPackage}
ˆüüüüüüüüüüüüüüü
=FAILURE
507007	The name ?0 has already been used for a package
=ENDDOC
\subsection{The SID function new\_scope\_pack\_body}
ÿPACK_SPEC_WITH_MODULESüüüüüüü
Ü	pack_spec_name : ID;
Ü	pack_spec_with_modules : seq Z_MODULE
ˆüüüüüüüüüüüüüüü
The information contained in the above global variable is extracted in the implementation from an additional field in the package type, see \cite{ISS/HAT/DAZ/DTD513}.
=DOC
	val Ûnew_scope_pack_bodyÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_pack_bodyüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_PARENTS;
Ü	IDENT;
Ü	PACK_ENV;
Ü	PACK_SPEC_WITH_MODULES;
Ü	Block;
Ü	Package'
÷üüüüüüüü
Ü	parents = {zmod'.mod_name};
Ü	z' = z ë §z_parents(Ê Z_PARENTS)¢;
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = pack_env ident;
Ü	pack_spec_name = ident;
Ü	block_name = ident;
Ü	pack_body_flag = True;
Ü	pack_spec_flag = stub_flag = subunit_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = {};
Ü	formal_procs = {};
Ü	dec_labels = {};
Ü	using_decs = {}
ˆüüüüüüüüüüüüüüü
Note: it is also necessary to update the bring into scope the auxiliary variables and formal procedures from the packages named in $pack\_spec\_with\_modules$.
This can conveniently be achieved in the implementation by calling $new\_scope\_with$, q.v.
=FAILURE
=ENDDOC
\pagebreak
\subsection{The SID function new\_scope\_with}
¹ZAX
Ü	new_ids : Package ­ ð ID
÷üüüüüüüüüüüüüü
ÜµPackage·
Ü	new_ids(ÊPackage) = 
Ü	{v : vc_vars · v.var} À
Ü	{c : Const_Decl | const_decl c  ran consts_types · c.const} À
Ü	{t : Type_Decl | type_decl t  ran consts_types · t.name} À
Ü	{ident : ID; Type_Decl; Enum_Type_Def |
Ü		type_decl(ÊType_Decl)  ran consts_types ±
Ü		type_def = enum_type_def(ÊEnum_Type_Def) ±
Ü		ident  ran vals · ident} À
Ü	{s : Subtype_Decl | subtype_decl s  ran consts_types · s.name} À
Ü	{p : formal_procs · p.name} À
Ü	{f : ran informal_funs · f.name} À
Ü	{f : ran formal_funs· f.name}
°
¹ZAX
Ü	prefix : (ID ¸ ðID ¸ Package) ­ Package
°
=DOC
	val new_scope_with : ID -> unit;
=DESCRIBE
ÿ new_scope_withüüüüüüü
Ü	„Z_DOC;
Ü	„ENV;
Ü	Z_MODULE;
Ü	Z_PARENTS;
Ü	IDENT;
Ü	PACK_ENV;
Ü	Block;
Ü	Package';
Ü	Z_DOC''
÷üüüüüüüü
Ü	z' = z'' ë z ë §z_parents(Ê Z_PARENTS)¢;
Ü	z'' = z_prefix(ident, new_ids(pack_env ident), (pack_env ident).zmod) ë
Ü		map (trans_informal_fun » z_ax) informal_funs'ë
Ü		map (trans_formal_fun » z_ax) formal_funs';
Ü	head z'' = z_module(Ê Z_MODULE);
Ü	parents = {mod_name};
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	ÊPackage' = prefix(ident, new_ids(pack_env ident), pack_env ident);
Ü	pack_body_flag = pack_spec_flag = stub_flag = subunit_flag =
Ü	formal_body_flag = fun_flag = declabel_flag =
Ü	speclabel_flag = till_flag = False;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = aux_vars';
Ü	formal_procs = formal_procs';
Ü	dec_labels = {}
ˆüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function end\_scope\_comp\_unit}
=DOC
val Ûend_scope_comp_unitÝ : unit -> unit;
=DESCRIBE
ÿend_scope_comp_unitüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = §blocks 1¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function aux\_var}
$AUX\_VAR$ is declared in \cite{ISS/HAT/DAZ/DTD502}.
=DOC
val Ûaux_varÝ : AUX_VAR -> unit;
=DESCRIBE
ÿaux_varüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	AUX_VAR;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	 pack_env «
Ü	 {block_name' í Package_aux_vars(ÊPackage, aux_vars À {aux})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507032	Declaration of ?0 has already been introduced 
=ENDDOC
\subsection{The SID function using\_dec}
$USING\_DEC$ is declared in \cite{ISS/HAT/DAZ/DTD502}.
=DOC
val Ûusing_decÝ : USING_DEC -> unit;
=DESCRIBE
ÿusing_decüüüüüüüüüüü
Ü	„ENV;
Ü	USING_DEC;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' =
Ü	 blocks «
Ü	 {1 í
Ü	  Block_using_decs
Ü	   (blocks 1, using_decs' À {aux í (concrete_vars, invariant)})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûadd_conc_vars_envÝ : unit -> unit;
=DESCRIBE
ÿadd_conc_vars_envüüüüüüüüüüü
Ü	„ENV;
Ü	Block'
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	blocks' =
Ü	 blocks «
Ü	 {1 í
Ü	  Block_vc_vars
Ü	   (blocks 1, vc_vars' À Þ{x : ran using_decs' · first x})}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function vcs\_aux\_initial}
=DOC
val Ûvcs_aux_initialÝ : STATEMENT -> unit;
=DESCRIBE
ÿvcs_aux_initialüüüüüüüüüüü
Ü	„Z_DOC;
Ü	ENV;
Ü	SEQ_STMTS;
Ü	PACK_ENV;
Ü	Block';
Ü	Speclab
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë § z_vcs (vcs (ÊSpeclab, st))¢;
Ü	vc_vars = vc_vars';
Ü	vc_pars = {};
Ü	vc_log_cons = {};
Ü	vc_aux_vars = {};
Ü	formal_procs = formal_procs';
Ü	fun_flag = False;
Ü	w = {v : vc_vars' · trans_id v.var};
Ü 	pre = z_many_and(
Ü        {v : dom var_inits‰1·z_eq(trans_id v, trans_exp(var_inits‰1 v))});
Ü	post =
Ü	 z_exists
Ü	 ((pack_env block_name').aux_vars,
Ü	 z_many_and {x : ran using_decs' · second x})
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{RENAMING DECLARATIONS}\label{RENAMINGDECLARATIONS}
\subsection{The SID function renames\_proc}
ÿRENAMES_NEWüüüüüüüüüüü
Ü	new:ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
ÿRENAMES_OLDüüüüüüüüüüü
Ü	pack,old:ID
ˆüüüüüüüüüüüüüüüüüüüüüüüüü

=DOC
val Ûrenames_proc_commonÝ : SUBPROGRAM_RENAMING -> FORMAL_PROC OPT;
val Ûrenames_proc_pack_specÝ : SUBPROGRAM_RENAMING -> unit;
val Ûrenames_proc_otherwiseÝ : SUBPROGRAM_RENAMING -> unit;
val Ûrenames_procÝ : SUBPROGRAM_RENAMING -> unit;
=DESCRIBE
ÿrenames_proc_commonüüüüüüüüüüü
Ü	ENV;
Ü	PACK_ENV;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD;
Ü	Package;
Ü	Block';
Ü	Formal_Proc'';
Ü	Formal_Proc'''
÷üüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	ÊPackage = prefix(pack, new_ids(pack_env pack), pack_env pack)
Ü	ÊFormal_Proc''  formal_procs;
Ü	name'' = pack dot old;
Ü	name''' = new;
Ü	formal_ids''' = formal_ids'';
Ü	ÊSpec''' = ÊSpec'';
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
ÿ renames_proc_pack_spec üüüüüüüüüüü
Ü „PACK_ENV
Ü renames_proc_common
Ü Package''
÷üüüüüü
Ü pack_spec_flag' = True
Ü pack ½ block_name'
Ü pack_env block_name' = ÊPackage''
Ü pack_env' =
Ü pack_env «  { block_name‰1 í
Ü   Package_formal_procs(ÊPackage'', formal_procs'' À {ÊFormal_Proc'''})}
ˆüüüüüüüüüüüüüü

ÿ renames_proc_otherwise üüüüüüüüüüü
Ü „ENV
Ü renames_proc_common
÷üüüüüü
Ü pack_spec_flag' = False
Ü blocks' = blocks « { 1 í
Ü    Block__formal_procs(ÊBlock', formal_procs' À {ÊFormal_Proc'''})}
ˆüüüüüüüüüüüüüü
¹Z
Ü renames_proc ¦ renames_proc_pack_spec ² renames_proc_otherwise
°
=FAILURE
507049	Cannot rename procedure ?0 from the current package
=ENDDOC
\subsection{The SID function renames\_fun}

=DOC
val Ûrenames_funÝ : SUBPROGRAM_RENAMING -> unit;
=DESCRIBE
ÿrenames_funüüüüüüüüüüü
Ü	„Z_DOC;
Ü	RENAMES_NEW;
Ü	RENAMES_OLD
÷üüüüüüü
Ü	z' = z ë §z_eq_eq(trans_id new, zid(trans_id(pack dot old)))¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\section{STUBS AND SUBUNITS}\label{STUBSANDSUBUNITS}

\subsection{The SID function begin\_stub}
=DOC
val Ûbegin_stubÝ : unit -> unit;
=DESCRIBE
ÿbegin_stubüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks 1, True)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function end\_stub}
=DOC
val Ûend_stubÝ : unit -> unit;
=DESCRIBE
ÿend_stubüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = blocks « {1 í Block_stub_flag(blocks 1, False)}
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID function new\_scope\_subunit}
=DOC
val Ûnew_scope_subunitÝ : ID -> unit;
=DESCRIBE
ÿnew_scope_subunitüüüüüüüüüüü
Ü	„ENV;
Ü	IDENT;
Ü	Empty_Block
÷üüüüüüü
Ü	blocks' = §Ê Block¢ ë blocks;
Ü	block_name = ident;
Ü	subunit_flag = True;
Ü	pack_spec_flag = pack_body_flag = stub_flag = formal_body_flag =
Ü	fun_flag = declabel_flag = speclabel_flag = till_flag = False
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC

\section{WEB CLAUSES}\label{WEBCLAUSES}
\subsection{The SID function z\_copy}
ÿZPARAüüüüüüüüüüü
Ü	zpara : Z_PARA
ˆüüüüüüüüüüüüüüü
ÿz_copyüüüüüüüüüüü
Ü	„Z_DOC;
Ü	ZPARA
÷üüüüüüü
Ü	z' = z ë §zpara¢
ˆüüüüüüüüüüüüüüü
\subsection{The SID function new\_scope\_dec\_replace}
=DOC
val Ûnew_scope_dec_replaceÝ : REPLACED_BY_DECL -> unit;
=DESCRIBE
ÿnew_scope_dec_replaceüüüüüüüüüüü
Ü	„ENV;
Ü	„DEC_ENV;
Ü	LAB;
Ü	Block
÷üüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	ÊDeclab = Declab_declabel_flag(dec_env label, True);
Ü	dec_lab = label;
Ü	dec_env' = {label} á dec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507002	?0 has not been introduced as a declaration label
=ENDDOC

\subsection{The SID function update\_envs\_remove\_declabel}
=DOC
	val Ûupdate_subunit_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_subunit_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		s' = Subunit_dec_labels (s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_dec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		d' = Declab_dec_labels(d, d.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_spec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Speclab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		s' = Speclab_dec_labels(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
Ü		update_envs_remove_declabel
Ü	¦	update_subunit_env_remove_declabel
Ü	±	update_dec_env_remove_declabel
Ü	±	update_spec_env_remove_declabel
°
=ENDDOC
\subsection{The SID function new\_scope\_speclabel}
=DOC
	val Ûnew_scope_speclabelÝ: LABEL -> unit
=DESCRIBE
ÿnew_scope_speclabelüüüüüüüüüüüüüü
Ü	„ENV;
Ü	LAB;
Ü	SPEC_ENV;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	speclabel_flag = True;
Ü	till_flag = (spec_env label).till_flag;
Ü	pack_spec_flag = pack_body_flag = stub_flag =
Ü	subunit_flag = formal_body_flag = fun_flag = declabel_flag = False;
Ü	spec_lab = label;
Ü	till = (spec_env label).till
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?0 has not been introduced
=ENDDOC
\subsection{The SID function vcs\_speclabel}
=DOC
	val Ûvcs_speclabelÝ: REFINED_BY -> unit
=DESCRIBE
ÿvcs_speclabelüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	SEQ_STMTS;
Ü	SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(spec_env spec_lab', st))¢	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü

=ENDDOC
\subsection{The SID function end\_scope\_speclabel}
=DOC
	val Ûend_scope_speclabelÝ: unit -> unit
=DESCRIBE
ÿend_scope_speclabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	end_scope;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	spec_env' = {spec_lab'} á spec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{The SID functions new\_scope\_stmtlabel and end\_scope\_stmt\_label}
=DOC
	val Ûnew_scope_stmt_labelÝ: LABEL -> unit
	val Ûend_scope_stmt_labelÝ: unit -> unit
=DESCRIBE
¹Z
Ü	new_scope_stmt_label ¦ new_scope_speclabel
°
¹Z
Ü	end_scope_stmt_label ¦ end_scope_speclabel
°
=ENDDOC

=DOC
val Ûget_thy_compilation_unitÝ : string -> string;
=DESCRIBE
Implementing Check 17 causes each theory that contains a compilation unit
to be assigned a string naming that compilation unit and its type. 
This function returns this string for a named theory.
=ENDDOC
\section{SPARK PROGRAM ENVIRONMENT}
The SPARK program environment enables the SPARK program to be recovered.
The relevant data structures are described in \cite{ISS/HAT/DAZ/DTD513}.
 
To describe the manipulation of this environment, we use some additional SID functions.

\subsection{The SID Function update\_replacement\_env}

This is called at the following points in the syntax.

=GFT
web_clause =
	z,
	compilation <update_spark_prog>,
	comp_label replacedby compilation <update_replacement_env>,
	ppart_label replacedby private_part <update_replacement_env>,
	vpart_label replacedby visible_part <update_replacement_env>,
	dec_label replacedby dec dp1 <update_replacement_env>,
	stmt_label replacedby sequence_of_statements <update_replacement_env>,
	spec_label refinedby sequence_of_statements <update_replacement_env>,
	refinedby sequence_of_statements <update_replacement_env>,
	spec_label replacedby sequence_of_statements <update_replacement_env>,
	replacedby sequence_of_statements <update_replacement_env>;
=TEX
(The manipulation of the replacement environment does not interact with the other SID functions, and so the interleaving of calls to $update\_replacement\_env$ and the other SID functions is immaterial).

The global variable $REPL$ holds the right-hand side of the current replacement or refinement web clause:

ÿREPLüüüüüüüüüüüüüü
Ü	repl : Replacement
ˆüüüüüüüüüüüüüüüüü
The global variable $COMP$ holds the current k-slot or compilation unit web clause:

ÿCOMPüüüüüüüüüüüüüü
Ü	comp : K_Slot_Compilation_Unit
ˆüüüüüüüüüüüüüüüüü

$update\_replacement\_env$ adds the maplet mapping the current label (in the global variable $LAB$) to $REPL$ to the replacement environment.
=DOC
val Ûupdate_replacement_envÝ : LABEL * REPLACEMENT -> unit
=DESCRIBE
ÿupdate_replacement_envüüüüüüüüüüüüüü
Ü	„REPL_ENV;
Ü	LAB;
Ü	REPL
÷üüüüüüüüüüüüüüü
Ü	repl_env' = repl_env « {label í repl}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûupdate_spark_progÝ : KSLOT_COMPILATION_UNIT list -> unit
=DESCRIBE
$update\_spark\_prog$ appends the current compilation to the sequence of same held in the SPARK program environment.

ÿupdate_spark_progüüüüüüüüüüüüüü
Ü	„SPARK_Prog;
Ü	COMP
÷üüüüüüüüüüüüüüü
Ü	spark' = spark ë §comp¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?0 has not been introduced
507004	label ?0 has already been refined or replaced
507005	label ?0 has already been used
=ENDDOC
\section{INTERFACE}
=DOC
val Ûget_z_generator_stateÝ : unit -> Z_GENERATOR_STATE
val Ûset_z_generator_stateÝ : Z_GENERATOR_STATE -> unit
val Ûdiag_z_generator_stateÝ : Z_GENERATOR_STATE ref
val Ûdiag_web_clauseÝ : WEB_CLAUSE ref;
val Ûdiag_vc_argsÝ : (SPECLAB * STATEMENT) list ref;
val Ûkslot_compilation_unit_nameÝ : KSLOT_COMPILATION_UNIT -> string;
val Ûadd_type_infoÝ : ID * ID list -> unit;
=DESCRIBE
=ENDDOC
=DOC
val Ûclassify_labelÝ : string -> REPL_SORT OPT
val Ûget_replacementÝ : string -> REPLACEMENT OPT
val Ûdo_web_clauseÝ : CNTypes.WEB_CLAUSE -> unit
=DESCRIBE
=ENDDOC

=DOC
type ÛCN_STATEÝ
val Ûget_cn_stateÝ : unit -> CN_STATE
val Ûset_cn_stateÝ : CN_STATE -> unit
val Ûinitial_cn_stateÝ : CN_STATE
val Ûnew_scriptÝ : {name : string, state : CN_STATE} -> unit
val Ûnew_script1Ý : {name : string, state : CN_STATE, library_theories : string list} -> unit
val Ûcn_z_generatorÝ : CNTypes.WEB_CLAUSE -> unit
val Ûrestart_cn_z_generatorÝ : unit -> unit
val Ûget_script_theoriesÝ : string -> string list
=DESCRIBE
$new\_script1$ acts the same as $new\_script$ except that its list
of library theories will be made the parents of the script theory,
and any theory produced during processing the script.	
=FAILURE
507017	Representation clauses are not handled formally
507018	Nested packages are not handled formally
507019	Internal error: unexpected abstract syntax category encountered
507020	Reverse loops are not handled formally
507021	Deferred constant declarations are not handled formally
507023	Cannot introduce theory ?0; a declaration for package
	?1 has probably already been processed
507024	Cannot introduce theory ?0; a body for package
	?1 has probably already been processed
507025	Cannot introduce theory ?0; a main program called
	?1 may already have been processed
507026	Cannot introduce theory ?0; a stub for the subunit
	?1 may already have been processed
507027	Cannot open theory ?0; a stub for the subunit
	?1 has not been processed
507028	Cannot open theory ?0; a declaration for the package
	?1 has not been processed
507029	Design error: information required for package ?0 has vanished
507030	Cannot introduce package body: a specification for package ?0 has not been processed
507031	Package name ?0 appears more than once in the context clause
507034 Cannot make theory ?0 a parent of theory ?1: ?2
507035 Cannot make theory ?0 a parent of theory ?1: theory ?0 does not exist
507036	This renaming declaration cannot be handled formally (?0 is not a formal procedure)
507037	This renaming declaration cannot be handled formally: ?0
507038	A specification for package ?0 has not been processed
507039	Arbitrary Ada replacements may violate VC soundness
507040	A specification for package ?0 is not allowed here because the
	theory ?1 already exists (perhaps because a specification for
	the package has already been processed)
507042	Library theory ?0 cannot be made a parent of the script theory: ?1
507044	This renaming declaration cannot be handled formally (?0 not successfully processed because ?1)
507045	A script may not contain more than one compilation unit:
	cannot add compilation unit ?0 to script ?1 as it already contains
	compilation unit ?2.
507046	DESIGN ERROR: Corrupt compilation unit data for theory ?0
507047	DESIGN ERROR: Should be called in theory ?0 but currently in ?1
507048	?0 appear to be one or more SPARK functions from the same package
	specification that specifies function ?1, which may not be used
	in the specification of that function
507053	Free variable ?0 found in checking predicate ?1 of formal procedure
507054	Free variables ?0 found in checking predicate ?1 of formal procedure
507055	Formal parameter ?0 in package ?1 clashes with a name declared in
	package that must be prefixed.
=ENDDOC
\section{EPILOGUE}
=SML
end; (* local...in *)
end; (* signature CNZGenerator *)
=TEX
\section{TEST POLICY}
The functions in this document do not lend themselves to module testing (as discussed in \cite{ISS/HAT/DAZ/HLD503}). Testing of the design and implementation of the Z document generator will be done using suitable integration tests.

Testing will be in accordance with the criteria identified in \cite{ISS/HAT/DAZ/PLN003}.

\small
\twocolumn[\section{INDEX}]
\printindex

\end{document}



