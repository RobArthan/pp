%  dtd507.doc %Z% $Date$ $Revision$ $RCSfile$
=TEX
% TQtemplate.tex
\documentstyle[hol1,11pt,TQ]{article}
\ftlinepenalty=9999
\def\Hide#1{}
\def\Bool{``$\it{:}bool\,$''}
\makeindex
\TPPproject{DAZ PROJECT}  %% Mandatory field
%\TPPvolume{}
%\TPPpart{}
\TPPtitle{Detailed Design: Z Generator}  %% Mandatory field
\TPPref{ISS/HAT/DAZ/DTD507}  %% Mandatory field
\def\SCCSversion{$Revision$%
}
\TPPissue{\SCCSversion}  %% Mandatory field
\TPPdate{\FormatDate{$Date$%
}}
%\TPPstatus{Approved}
\TPPstatus{Draft}
\TPPtype{Specification}
\TPPkeywords{SPARK}
\TPPauthor{R.D.~Arthan&WIN01}
\TPPauthorisation{D.J.~King & DAZ Team Leader}
\TPPabstract{
This document contains the detailed design for the
Compliance Notation Specification Database.}
%\TPPabstractB{}
%\TPPabstractC{}
%\TPPabstractD{}
%\TPPabstractE{}
%\TPPabstractF{}
\TPPdistribution{\parbox[t]{4.0in}{%
	Library}}

%\TPPclass{CLASSIFICATION}
%\def\TPPheadlhs{}
%\def\TPPheadcentre{}
%def\TPPheadrhs{}
%\def\TPPfootlhs{}
%\def\TPPfootcentre{}
%\def\TPPfootrhs{}

\begin{document}
\TPPsetsizes
\makeTPPfrontpage

\vfill
\begin{centering}

\bf Copyright \copyright\ : International Computers Ltd \number\year

\end{centering}

\newpage
\section{DOCUMENT CONTROL}
\subsection{Contents List}
\tableofcontents
\subsection{Document Cross References}
\bibliographystyle{fmu}
\bibliography{fmu,hatdocs,daz}

\subsection{Changes History}  % to get section number `0.3'
\begin{description}
\item[Issue \SCCSversion~\FormatDate{$Date$%
}) ] Initial Draft.

\end{description}
\subsection{Changes Forecast}
\section{GENERAL}
\subsection{Scope}
This document contains the detailed design for the functions whose Z specification is given in in \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0}; it is called for in \cite{ISS/HAT/DAZ/HLD503}.
Sections \ref{BASICDECLARATIONS}-\ref{WEBCLAUSES} contain the design and correspond directly with sections 4-15 of the DRA specification.

\subsection{Introduction}
This document gives the structure (i.e., module) containing the functions defined \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0}.
This covers the main semantic processing involved in the extraction of a Z document from a Compliance Notation script.
As usual it also includes a transcription into {\ProductZ} of the relevant parts of the DRA specification.

The overall effect of the processing defined here is to update the {\Product} theory database as if the Z document had been loaded into it and to update internal state representing the environments of  \cite[Volume 1]{DRA/CIS/CSE3/TR/94/27/1.0} as implemented in \cite{ISS/HAT/DAZ/DTD513}.
The internal state also includes additional information defined in \cite{ISS/HAT/DAZ/DTD513} and used to record the association of k-slot labels with SPARK program fragments.
This gives all the information required to reduce extraction of the Z document and of the SPARK program to straightforward pretty-printing tasks.

\subsubsection{Purpose and Background}
See \cite{ISS/HAT/DAZ/HLD503}.


\subsubsection{Dependencies}
See \cite{ISS/HAT/DAZ/HLD503}.
%\subsubsection{Possible Enhancements}
\subsubsection{Deficiencies}
None known.

\section{DESIGN ISSUES}
\section{PREAMBLE}
=DOC
signature ÛCNZGeneratorÝ = sig
=DESCRIBE
=ENDDOC

=SML
local
open	CNTypes CNTypes1;
in
=TEX
\section{BASIC DECLARATIONS}\label{BASICDECLARATIONS}
\subsection{The SID Function $basic\_declaration$}
ÿBASIC_DECLüüüüüüüüüüüüüüüüüüüüü
Ü	basic_decl : BASIC_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûbasic_decl_pack_specÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_consts_types(ÊPackage, consts_types ë §basic_decl¢ }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_decl_otherwiseÝ : BASIC_DECL -> unit;
=DESCRIBE
ÿbasic_decl_otherwiseüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	BASIC_DEC;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = False;
Ü	ÊBlock' = blocks 1;
Ü	z' =
Ü	z ë trans_basic_decl basic_decl
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûbasic_declarationÝ : BASIC_DECL -> unit;
=DESCRIBE
¹Z
	basic_declaration ¦ basic_decl_pack_spec ² basic_decl_otherwise
°
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function $var\_pack\_spec$}
ÿVAR_DECLüüüüüüüüüüüüüüüüüüüüü
Ü	vars : ð VAR_DECL
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüüü
=DOC
val Ûvar_pack_specÝ : VAR_DECL -> unit;
=DESCRIBE
In the implementation, variable declarations contain lists of identifiers, rather than single identifiers (i.e., they are as in the concrete syntax rather than the Z abstract syntax).
We therefore only deal with a single $VAR\_DECL$ here.
ÿvar_pack_specüüüüüüüüüüüüüü
Ü	„PACK_ENV;
Ü	VAR_DECL;
Ü	ENV;
Ü	Package;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	pack_spec_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	pack_env block_name' = ÊPackage;
Ü	pack_env' =
Ü	pack_env «
Ü	{ block_name' í
Ü		Package_vc_vars(ÊPackage, vc_vars À vars }
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC
\subsection{The SID Function $update\_envs\_var$}
=DOC
val Ûupdate_subunit_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_subunit_env_varüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Subunit_vc_vars(s, s.vc_vars À vars) ²
Ü		decl_lab' Ž s.dec_labels ± s' = s
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_dec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_dec_env_varüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		dec_lab'  d.dec_labels ±
Ü		d' = Declab_vc_vars(d, d.vc_vars À vars) ²
Ü		dec_lab' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_spec_env_varÝ : VAR_DECL -> unit;
=DESCRIBE
ÿupdate_spec_env_varüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	VAR_DECL;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	declabel_flag' = True;
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Declab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		dec_lab'  s.dec_labels ±
Ü		s' = Speclab_w
Ü		(Spec_lab_vc_vars(s, s.vc_vars À vars),
Ü		s.w À {v : vars· trans_if (v.var}) ²
Ü		dec_lab' Ž d.dec_labels ± d' = d
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC
=DOC
val Ûupdate_envs_varÝ : VAR_DECL -> unit;
=DESCRIBE
¹Z
		update_envs_var
	¦	update_subunit_env_var
	±	update_dec_env_var
	±	update_spec_env_var
°
=FAILURE
507001	internal error: running environment contains a non-existent
	package name
=ENDDOC

\section{DECLARATIONS}\label{DECLARATIONS}
\section{STATEMENTS}\label{STATEMENTS}
\section{LOOPS}\label{LOOPS}
\subsection{The SID function end\_scope}
=DOC
val Ûend_scopeÝ : unit -> unit;
=DESCRIBE
ÿend_scopeüüüüüüüüüüü
Ü	„ENV
÷üüüüüüü
Ü	blocks' = tail blocks
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507006	Internal error: unmatched end of scope
=ENDDOC

\section{SUBPROGRAM DECLARATIONS}\label{SUBPROGRAMDECLARATIONS}
\section{PROCEDURES}\label{PROCEDURES}
\section{FUNCTIONS}\label{FUNCTIONS}
\section{FORMAL PARAMETERS}\label{FORMALPARAMETERS}
\section{SUBPROGRAM BODIES}\label{SUBPROGRAMBODIES}
\section{PACKAGES}\label{PACKAGES}
\section{STUBS AND SUBUNITS}\label{STUBSANDSUBUNITS}
\section{WEB CLAUSES}\label{WEBCLAUSES}
\subsection{THE SID function z\_copy}
ÿZPARAüüüüüüüüüüü
Ü	zpara : Z_PARA
ˆüüüüüüüüüüüüüüü
ÿz_copyüüüüüüüüüüü
Ü	„Z_DOC;
Ü	Z_PARA
÷üüüüüüü
Ü	z' = z ë §zpara¢
ˆüüüüüüüüüüüüüüü
\subsection{THE SID function new\_scope\_dec\_replace}
=DOC
val Ûnew_scope_dec_replaceÝ : REPLACED_BY_DECL -> unit;
=DESCRIBE
ÿnew_scope_dec_replaceüüüüüüüüüüü
Ü	„ENV;
Ü	„DEC_ENV;
Ü	LAB;
Ü	Block
÷üüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	ÊDeclab = Declab_declabel_flag(dec_env label, True)
Ü	dec_lab = label;
Ü	dec_env' = {label} á dec_env
ˆüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507002	?1 has not been introduced as a declaration label
=ENDDOC

\subsection{THE SID function update\_envs\_remove\_declabel}
=DOC
	val Ûupdate_subunit_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_subunit_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SUBUNIT_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#subunit_env = #subunit_env';
Ü	µid‰1, id‰2 : ID; s, s' : Subunit |
Ü		subunit_env(id‰1, id‰2) = s ± subunit_env'(id‰1, id‰2) = s' ·
Ü		s' = Subunit_vc_vars(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_dec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_dec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„DEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#dec_env = #dec_env';
Ü	µdec_label : LABEL; d, d' : Declab |
Ü		dec_env dec_label = d ± dec_env' dec_label = d'·
Ü		d' = Declab_vc_vars(d, d.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_spec_env_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿupdate_spec_env_remove_declabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	#spec_env = #spec_env';
Ü	µspec_label : LABEL; s, s' : Declab |
Ü		spec_env spec_label = s ± spec_env' spec_label = s'·
Ü		s' = Speclab_vc_vars(s, s.dec_labels \ {dec_lab'})
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
	val Ûupdate_envs_remove_declabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
		update_envs_remove_declabel
	¦	update_subunit_env_remove_declabel
	±	update_dec_env_var
	±	update_spec_env_remove_declabel
°
=ENDDOC
\subsection{THE SID function new\_scope\_speclabel}
=DOC
	val Ûnew_scope_speclabelÝ: LABEL -> unit
=DESCRIBE
ÿnew_scope_speclabelüüüüüüüüüüüüüü
Ü	„ENV;
Ü	LAB;
Ü	SPEC_ENV;
Ü	Empty_Block
÷üüüüüüüüüüüüüüü
Ü	blocks' = §ÊBlock¢ ë blocks;
Ü	speclabel_flag = True;
Ü	till_flag = (spec_env label).till_flag;
Ü	pack_spec_flag = pack_body_flag = stub_flag =
Ü	subunit_flag = formal_body_flag = fun_flag = declabel_flag = False;
Ü	spec_lab = label;
Ü	till = (spec_env label).till
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?1 has not been introduced
=ENDDOC
\subsection{THE SID function vcs\_speclabel}
=DOC
	val Ûvcs_speclabelÝ: REFINED_BY -> unit
=DESCRIBE
ÿvcs_speclabelüüüüüüüüüüüüüü
Ü	„Z_DOC;
Ü	SEQ_STMTS;
Ü	SPEC_ENV;
Ü	ENV;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	z' = z ë §z_vcs(vcs(spec_env spec_lab', st))¢
Ü	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü

=ENDDOC
=ENDDOC
\subsection{THE SID function end\_scope\_speclabel}
=DOC
	val Ûend_scope_speclabelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
ÿend_scope_speclabelüüüüüüüüüüüüüü
Ü	„SPEC_ENV;
Ü	end_scope;
Ü	Block'
÷üüüüüüüüüüüüüüü
Ü	ÊBlock' = blocks 1;
Ü	spec_ebv' = {spec_lab'} á spec_env
Ü	
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
\subsection{THE SID functions new\_scope\_stmtlabel and end\_scope\_stmt\_label}
=DOC
	val Ûnew_scope_stmt\_labelÝ: REPLACED_BY_DECL -> unit
	val Ûend_scope_stmt\_labelÝ: REPLACED_BY_DECL -> unit
=DESCRIBE
¹Z
	new_scope_stmt_label ¦ new_scope_speclabel
°
¹Z
	end_scope_stmt_label ¦ end_scope_speclabel
°
=ENDDOC

\subsection{Replacement Environment Manipulation}
To describe the manipulation of the replacement environment, which allows the SPARK program to be extracted, we use an additional SID function.
This is called at the following points in the syntax.

=GFT
web_clause =
	z,
	compilation <update_spark_prog>,
	comp_label replacedby compilation <update_replacement_env>,
	ppart_label replacedby private_part <update_replacement_env>,
	vpart_label replacedby visible_part <update_replacement_env>,
	dec_label replacedby dec dp1 <update_replacement_env>,
	stmt_label replacedby sequence_of_statements <update_replacement_env>,
	spec_label refinedby sequence_of_statements <update_replacement_env>,
	refinedby sequence_of_statements <update_replacement_env>,
	spec_label replacedby sequence_of_statements <update_replacement_env>,
	replacedby sequence_of_statements <update_replacement_env>;
=TEX
(The manipulation of the replacement environment does not interact with the other SID functions, and so the interleaving of calls to $update\_replacement\_env$ and the other SID functions is immaterial).

The global variable $REPL$ holds the right-hand side of one of the replacement or refinement web clauses:

ÿREPLüüüüüüüüüüüüüü
Ü	repl : REPLACEMENT
ˆüüüüüüüüüüüüüüüüü
The global variable $COMP$ holds the current compilation (or k-slot):

ÿCOMPüüüüüüüüüüüüüü
Ü	comp : K_Slot_Compilation_Unit
ˆüüüüüüüüüüüüüüüüü

$update\_replacement\_env$ adds the maplet mapping the current label (in the global variable $LAB$) to $REPL$ to the replacement environment.
=DOC
val Ûupdate_spark_progÝ : LABEL * REPLACEMENT -> unit
=DESCRIBE

ÿupdate_replacemeent_envüüüüüüüüüüüüüü
Ü	„REPL_ENV;
Ü	LAB;
Ü	REPL
÷üüüüüüüüüüüüüüü
Ü	repl_env' = repl_env « {label í repl}
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=ENDDOC
=DOC
val Ûupdate_spark_progÝ : LABEL * REPLACEMENT -> unit
=DESCRIBE
$update\_spark\_prog$ appends the current compilation to the sequence of same held in the SPARK program environment.

ÿupdate_spark_progüüüüüüüüüüüüüü
Ü	„SPARK_Prog;
Ü	COMP
÷üüüüüüüüüüüüüüü
Ü	spark' = spark ë §comp¢
ˆüüüüüüüüüüüüüüüüüüüüüüüüüüü
=FAILURE
507003	label ?1 has not been introduced
507004	label ?1 has already been refined or replaced
507005	label ?1 has already been used
=ENDDOC
\section{INTERFACE}
=DOC
val Ûcn_z_generatorÝ : CNTypes.WEB_CLAUSE -> unit
=DESCRIBE
=ENDDOC
\section{EPILOGUE}
=SML
end; (* local...in *)
end; (* signature CNZGenerator *)
=TEX
\section{TEST POLICY}
The functions in this document are to be tested according to the
criteria identified in \cite{ISS/HAT/DAZ/PLN003}.

\small
\twocolumn[\section{INDEX}]
\printindex

\end{document}



